<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StoichBot - Chemistry Learning Platform</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-x: hidden;
        }

        html {
            height: 100%;
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #007bff;
        }

        .chat-toggle-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .chat-toggle-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        /* Hero Section */
        .hero {
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            padding: 100px 20px 50px;
        }

        .hero-content {
            max-width: 800px;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin: 0 0 20px 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .hero p {
            font-size: 1.3rem;
            margin: 0 0 40px 0;
            opacity: 0.9;
            line-height: 1.6;
        }

        .hero-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,123,255,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
        }

        .btn-secondary:hover {
            background: white;
            color: #007bff;
            transform: translateY(-3px);
        }

        /* Features Section */
        .features {
            padding: 80px 20px;
            background: white;
        }

        .features-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .features h2 {
            text-align: center;
            font-size: 2.5rem;
            margin: 0 0 60px 0;
            color: #333;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 40px;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            transition: transform 0.3s;
            border: 1px solid #e9ecef;
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .feature-card h3 {
            font-size: 1.5rem;
            margin: 0 0 15px 0;
            color: #333;
        }

        .feature-card p {
            color: #666;
            line-height: 1.6;
            margin: 0;
        }

        /* Chat Interface */
        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 90%;
            max-height: 700px;
            background: white;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-chat:hover {
            background: rgba(255,255,255,0.2);
        }

        .welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .welcome-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .welcome-card h2 {
            color: #007bff;
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .welcome-card p {
            color: #666;
            margin: 0 0 30px 0;
            line-height: 1.6;
        }

        .welcome-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .age-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .age-option {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
        }

        .age-option:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .age-option.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .start-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .start-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .start-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 300px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .message.user .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .quick-actions {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .quick-actions h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .action-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #495057;
        }

        .action-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        /* FIXED CHAT INPUT - MOBILE FRIENDLY */
        .chat-input {
            padding: 20px;
            background: white;
            border-top: 2px solid #e9ecef;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            width: 100%;
        }

        .input-field {
            flex: 1;
            border: 2px solid #007bff !important;
            border-radius: 25px;
            padding: 15px 20px !important;
            font-size: 16px !important;
            outline: none;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            font-family: inherit;
            background: white !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            box-sizing: border-box;
        }

        .input-field:focus {
            border-color: #0056b3 !important;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .send-btn {
            background: #007bff !important;
            color: white !important;
            border: none !important;
            border-radius: 50% !important;
            width: 50px !important;
            height: 50px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s !important;
            font-size: 20px !important;
            flex-shrink: 0 !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .send-btn:hover {
            background: #0056b3 !important;
            transform: scale(1.05) !important;
        }

        .send-btn:disabled {
            background: #6c757d !important;
            cursor: not-allowed !important;
            transform: none !important;
        }

        .typing-indicator {
            display: none;
            padding: 10px 16px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 70%;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Quiz Styles */
        .quiz-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .quiz-selector-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
        }

        .quiz-selector-header h3 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 20px;
        }

        .quiz-selector-header p {
            margin: 0 0 20px 0;
            color: #666;
        }

        .quiz-settings {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-group label {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .difficulty-options, .question-count-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .difficulty-btn, .count-btn {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .difficulty-btn:hover, .count-btn:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .difficulty-btn.selected, .count-btn.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .start-quiz-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .start-quiz-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .start-quiz-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .quiz-question {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quiz-option {
            background: white;
            border: 2px solid #dee2e6;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quiz-option:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .quiz-option.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .quiz-option.correct {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }

        .quiz-option.incorrect {
            border-color: #dc3545;
            background: #dc3545;
            color: white;
        }

        /* Balance Calculator Styles */
        .balance-calculator-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
        }

        .calculator-header h3 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 20px;
        }

        .calculator-header p {
            margin: 0 0 20px 0;
            color: #666;
        }

        .equation-input-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .equation-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .equation-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .arrow-symbol {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 0 10px;
        }

        .calculator-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .balance-btn, .clear-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .balance-btn {
            background: #28a745;
            color: white;
        }

        .balance-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .clear-btn {
            background: #6c757d;
            color: white;
        }

        .clear-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .result-section {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .balanced-result h4 {
            margin: 0 0 15px 0;
            color: #28a745;
        }

        .equation-display {
            font-size: 18px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #28a745;
        }

        .balance-explanation {
            margin-top: 20px;
        }

        .balance-explanation h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }

        .balance-explanation p {
            margin: 0 0 15px 0;
            line-height: 1.6;
        }

        .steps h5 {
            margin: 15px 0 10px 0;
            color: #333;
        }

        .steps ol {
            margin: 0;
            padding-left: 20px;
        }

        .steps li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .calculator-help {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 10px;
        }

        .calculator-help h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }

        .calculator-help ul {
            margin: 0;
            padding-left: 20px;
        }

        .calculator-help li {
            margin-bottom: 5px;
            color: #6c757d;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            text-align: center;
            font-weight: 600;
        }

        /* MOBILE RESPONSIVE FIXES */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .hero p {
                font-size: 1.1rem;
            }
            
            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-links {
                display: none;
            }
            
            .chat-container {
                width: 95%;
                height: 95%;
                max-height: 90vh;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .equation-input-section {
                flex-direction: column;
            }
            
            .input-group {
                min-width: 100%;
            }
            
            /* CRITICAL MOBILE INPUT FIXES */
            .chat-input {
                padding: 15px !important;
                background: white !important;
                border-top: 2px solid #007bff !important;
                position: sticky !important;
                bottom: 0 !important;
                z-index: 100 !important;
            }
            
            .input-container {
                display: flex !important;
                gap: 10px !important;
                align-items: flex-end !important;
                width: 100% !important;
            }
            
            .input-field {
                flex: 1 !important;
                border: 3px solid #007bff !important;
                border-radius: 25px !important;
                padding: 15px 20px !important;
                font-size: 16px !important;
                outline: none !important;
                resize: none !important;
                min-height: 25px !important;
                max-height: 80px !important;
                font-family: inherit !important;
                background: white !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                box-sizing: border-box !important;
            }
            
            .send-btn {
                background: #007bff !important;
                color: white !important;
                border: none !important;
                border-radius: 50% !important;
                width: 50px !important;
                height: 50px !important;
                cursor: pointer !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 20px !important;
                flex-shrink: 0 !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            .quick-actions {
                padding: 10px 15px;
                background: white;
                border-top: 1px solid #e9ecef;
                max-height: 120px;
                overflow-y: auto;
            }
            
            .action-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }
            
            .action-btn {
                font-size: 11px;
                padding: 6px 10px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Navigation -->
  <nav class="navbar">
   <div class="nav-container"><a href="#" class="logo" id="site-title">StoichBot</a>
    <ul class="nav-links">
     <li><a href="#home">Home</a></li>
     <li><a href="#features">Features</a></li>
     <li><a href="#about">About</a></li>
    </ul><button class="chat-toggle-btn" onclick="openChat()">💬 Start Learning</button>
   </div>
  </nav><!-- Hero Section -->
  <section class="hero" id="home">
   <div class="hero-content">
    <h1 id="hero-title">Master Chemistry with StoichBot</h1>
    <p id="hero-subtitle">Your AI-powered chemistry tutor specialized in stoichiometry. Learn, practice, and excel with personalized guidance!</p>
    <div class="hero-buttons"><button class="btn btn-primary" onclick="openChat()">🚀 Start Learning Now</button> <a href="#features" class="btn btn-secondary">📚 Explore Features</a>
    </div>
   </div>
  </section><!-- Features Section -->
  <section class="features" id="features">
   <div class="features-container">
    <h2>Why Choose StoichBot?</h2>
    <div class="features-grid">
     <div class="feature-card">
      <div class="feature-icon">
       🤖
      </div>
      <h3>AI-Powered Tutoring</h3>
      <p>Get personalized explanations adapted to your age and learning level. Our AI understands your needs and adjusts accordingly.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       ⚖️
      </div>
      <h3>Equation Balancer</h3>
      <p>Interactive calculator that balances chemical equations step-by-step with detailed explanations of the process.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       🎯
      </div>
      <h3>Practice Quizzes</h3>
      <p>Test your knowledge with customizable quizzes. Choose difficulty levels and track your progress over time.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       📊
      </div>
      <h3>Problem Solving</h3>
      <p>Step-by-step solutions for stoichiometry problems with clear explanations and calculation methods.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       🔬
      </div>
      <h3>Concept Mastery</h3>
      <p>Deep dive into mole concepts, limiting reactants, percent yield, and all essential stoichiometry topics.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       💾
      </div>
      <h3>Progress Tracking</h3>
      <p>Your conversations and progress are saved automatically. Pick up where you left off anytime!</p>
     </div>
    </div>
   </div>
  </section><!-- Chat Overlay -->
  <div class="chat-overlay" id="chatOverlay">
   <div class="chat-container">
    <div class="welcome-screen" id="welcomeScreen">
     <div class="welcome-card">
      <h2>👋 Welcome to StoichBot!</h2>
      <p>I'm your personal chemistry assistant, specialized in stoichiometry. Let's get to know each other first!</p>
      <form class="welcome-form" onsubmit="startChat(event)">
       <div class="form-group"><label for="nickname">What should I call you?</label> <input type="text" id="nickname" class="form-input" placeholder="Enter your nickname" required>
       </div>
       <div class="form-group"><label>What's your age group?</label>
        <div class="age-selector">
         <div class="age-option" onclick="selectAge('13-15', this)">
          13-15 years
         </div>
         <div class="age-option" onclick="selectAge('16-18', this)">
          16-18 years
         </div>
         <div class="age-option" onclick="selectAge('19-21', this)">
          19-21 years
         </div>
         <div class="age-option" onclick="selectAge('22+', this)">
          22+ years
         </div>
        </div><input type="hidden" id="selectedAge" required>
       </div><button type="submit" class="start-btn" id="startBtn" disabled> 🚀 Start Learning Chemistry! </button>
      </form>
     </div>
    </div>
    <div class="chat-header">
     <h3 id="chatbot-name">StoichBot - Your Chemistry Assistant</h3><button class="close-chat" onclick="closeChat()">×</button>
    </div>
    <div class="chat-messages" id="chatMessages">
     <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots">
       <div class="typing-dot"></div>
       <div class="typing-dot"></div>
       <div class="typing-dot"></div>
      </div>
     </div>
    </div>
    <div class="quick-actions">
     <h4>Quick Actions</h4>
     <div class="action-buttons"><button class="action-btn" onclick="sendQuickMessage('What is stoichiometry?')">🧪 Stoichiometry Basics</button> <button class="action-btn" onclick="sendQuickMessage('Help me balance equations')">⚖️ Balance Equations</button> <button class="action-btn" onclick="sendQuickMessage('Solve stoichiometry problem')">🧮 Problem Solving</button> <button class="action-btn" onclick="sendQuickMessage('Start quiz')">🎯 Take Quiz</button> <button class="action-btn" onclick="sendQuickMessage('Explain limiting reactants')">🔬 Limiting Reactants</button>
     </div>
    </div><!-- FIXED CHAT INPUT SECTION -->
    <div class="chat-input">
     <div class="input-container"><textarea id="messageInput" class="input-field" placeholder="Type your chemistry question here..." rows="1" onkeypress="handleKeyPress(event)" oninput="adjustTextareaHeight(this)"></textarea> <button class="send-btn" id="sendBtn" onclick="sendMessage()"> ➤ </button>
     </div>
    </div>
   </div>
  </div>
  <script>
        let currentLanguage = 'en';
        let chatHistory = [];
        let isLoading = false;
        let userProfile = {
            nickname: '',
            age: '',
            isSetup: false
        };
        
        const defaultConfig = {
            site_title: 'StoichBot',
            hero_title: 'Master Chemistry with StoichBot',
            hero_subtitle: 'Your AI-powered chemistry tutor specialized in stoichiometry. Learn, practice, and excel with personalized guidance!',
            chatbot_name: 'StoichBot',
            welcome_message: 'Hello! I\'m your chemistry assistant specialized in stoichiometry. How can I help you today?',
            primary_color: '#007bff',
            surface_color: '#ffffff'
        };

        // Stoichiometry-related keywords for scope checking
        const stoichiometryKeywords = [
            'mole', 'mol', 'stoichiometry', 'stoichiometric', 'avogadro', 'balance', 'equation', 'chemical',
            'reaction', 'reactant', 'product', 'limiting', 'excess', 'yield', 'percent', 'theoretical',
            'actual', 'mass', 'molecular', 'atomic', 'formula', 'empirical', 'compound', 'element',
            'coefficient', 'ratio', 'proportion', 'calculate', 'conversion', 'gram', 'kilogram',
            'molecule', 'atom', 'ion', 'chemistry', 'periodic', 'table', 'concentration', 'molarity',
            'solution', 'solute', 'solvent', 'gas', 'stp', 'volume', 'pressure', 'temperature'
        ];

        const dataHandler = {
            onDataChanged(data) {
                chatHistory = data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                renderChatHistory();
            }
        };

        const elementHandler = {
            defaultConfig: defaultConfig,
            onConfigChange: async (config) => {
                document.getElementById('site-title').textContent = config.site_title || defaultConfig.site_title;
                document.getElementById('hero-title').textContent = config.hero_title || defaultConfig.hero_title;
                document.getElementById('hero-subtitle').textContent = config.hero_subtitle || defaultConfig.hero_subtitle;
                document.getElementById('chatbot-name').textContent = config.chatbot_name || defaultConfig.chatbot_name;
                
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                const surfaceColor = config.surface_color || defaultConfig.surface_color;
                
                document.documentElement.style.setProperty('--primary-color', primaryColor);
                document.documentElement.style.setProperty('--surface-color', surfaceColor);
                
                const buttons = document.querySelectorAll('.btn-primary, .chat-toggle-btn, .send-btn, .start-btn');
                buttons.forEach(btn => {
                    btn.style.backgroundColor = primaryColor;
                });
                
                const userMessages = document.querySelectorAll('.message.user .message-content');
                userMessages.forEach(msg => {
                    msg.style.backgroundColor = primaryColor;
                });
            },
            mapToCapabilities: (config) => ({
                recolorables: [
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            config.primary_color = value;
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    },
                    {
                        get: () => config.surface_color || defaultConfig.surface_color,
                        set: (value) => {
                            config.surface_color = value;
                            window.elementSdk.setConfig({ surface_color: value });
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
                ['site_title', config.site_title || defaultConfig.site_title],
                ['hero_title', config.hero_title || defaultConfig.hero_title],
                ['hero_subtitle', config.hero_subtitle || defaultConfig.hero_subtitle],
                ['chatbot_name', config.chatbot_name || defaultConfig.chatbot_name],
                ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
            ])
        };

        async function initializeApp() {
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error('Failed to initialize data SDK');
                }
            }

            if (window.elementSdk) {
                await window.elementSdk.init(elementHandler);
            }
        }

        function openChat() {
            document.getElementById('chatOverlay').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Force focus on input field for mobile
            setTimeout(() => {
                const inputField = document.getElementById('messageInput');
                if (inputField) {
                    inputField.focus();
                }
            }, 500);
        }

        function closeChat() {
            document.getElementById('chatOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function selectAge(age, element) {
            document.querySelectorAll('.age-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedAge').value = age;
            
            const nickname = document.getElementById('nickname').value.trim();
            document.getElementById('startBtn').disabled = !nickname;
        }

        function startChat(event) {
            event.preventDefault();
            
            const nickname = document.getElementById('nickname').value.trim();
            const age = document.getElementById('selectedAge').value;
            
            if (!nickname || !age) return;
            
            userProfile = {
                nickname: nickname,
                age: age,
                isSetup: true
            };
            
            document.getElementById('welcomeScreen').style.display = 'none';
            showPersonalizedWelcome();
            
            // Focus on input after welcome
            setTimeout(() => {
                const inputField = document.getElementById('messageInput');
                if (inputField) {
                    inputField.focus();
                }
            }, 1000);
        }

        function showPersonalizedWelcome() {
            const config = window.elementSdk?.config || defaultConfig;
            const botName = config.chatbot_name || defaultConfig.chatbot_name;
            
            let welcomeMsg = `Hi ${userProfile.nickname}! 👋 I'm ${botName}, your personal chemistry assistant! `;
            
            if (userProfile.age === '13-15') {
                welcomeMsg += `I'll explain things in a simple and fun way that's perfect for your grade level. Ready to explore the amazing world of stoichiometry together? 🧪✨`;
            } else if (userProfile.age === '16-18') {
                welcomeMsg += `I'll help you master stoichiometry concepts for your senior high school chemistry. Let's tackle those challenging problems step by step! 📚🔬`;
            } else if (userProfile.age === '19-21') {
                welcomeMsg += `Perfect! I'll provide detailed explanations suitable for college-level chemistry. Ready to dive deep into stoichiometric calculations? 🎓⚗️`;
            } else {
                welcomeMsg += `Great to meet you! I'll provide comprehensive explanations and advanced problem-solving techniques. Let's explore stoichiometry together! 🔬📊`;
            }
            
            addMessage(welcomeMsg, 'bot');
        }

        function isCompletelyUnrelated(message) {
            const lowerMessage = message.toLowerCase();
            
            // Common greetings and casual conversation - these should NOT trigger fallback
            const casualPatterns = [
                /^(hi|hello|hey|good morning|good afternoon|good evening|kamusta|kumusta|musta|sup|what's up|whats up)$/i,
                /^(how are you|how r u|kamusta ka|okay ka ba|fine ka ba)$/i,
                /^(thank you|thanks|salamat|ty|tysm|thank u)$/i,
                /^(bye|goodbye|see you|see ya|paalam|sige na)$/i,
                /^(yes|no|ok|okay|sure|alright|sige|oo|hindi)$/i,
                /^(nice|cool|great|awesome|amazing|galing|maganda)$/i,
                /^(sorry|pasensya|my bad|oops)$/i,
                /^(who are you|what are you|sino ka|ano ka)$/i,
                /^(help|tulong|assist)$/i,
                /^(start|begin|umpisa|simula)$/i
            ];
            
            // If it's a casual/greeting pattern, it's NOT unrelated
            if (casualPatterns.some(pattern => pattern.test(lowerMessage))) {
                return false;
            }
            
            // Chemistry and stoichiometry related keywords - these should NOT trigger fallback
            const chemistryKeywords = [
                ...stoichiometryKeywords,
                'what is', 'explain', 'how to', 'help me', 'teach me', 'show me',
                'calculate', 'solve', 'find', 'determine', 'compute',
                'quiz', 'test', 'exam', 'question', 'practice',
                'balance', 'equation', 'reaction', 'formula',
                'mass', 'weight', 'gram', 'kg', 'pound',
                'percent', 'percentage', 'yield', 'efficiency',
                'limiting', 'excess', 'leftover', 'remaining',
                'avogadro', 'number', 'constant', '6.022',
                'molecular', 'atomic', 'molar', 'molarity',
                'concentration', 'solution', 'mixture',
                'gas', 'liquid', 'solid', 'state', 'phase',
                'temperature', 'pressure', 'volume', 'stp',
                'periodic', 'table', 'element', 'compound',
                'ion', 'ionic', 'covalent', 'bond',
                'coefficient', 'subscript', 'superscript',
                'reactant', 'product', 'catalyst', 'inhibitor',
                'chemistry', 'chemical', 'science', 'lab', 'laboratory',
                'study', 'learn', 'understand', 'school', 'class',
                'homework', 'assignment', 'project', 'research'
            ];
            
            const hasChemKeywords = chemistryKeywords.some(keyword => lowerMessage.includes(keyword));
            
            // Chemistry question patterns - these should NOT trigger fallback
            const chemQuestionPatterns = [
                /what.*is.*\b(mol|atom|molecule|element|compound|reaction|equation|balance|mass|weight|formula|chemical|chemistry|stoich)/i,
                /how.*to.*\b(calculate|solve|find|balance|determine|compute)/i,
                /explain.*\b(mol|atom|molecule|element|compound|reaction|equation|balance|mass|weight|formula|chemical|chemistry|stoich)/i,
                /help.*me.*\b(with|understand|learn|solve|calculate|balance)/i,
                /\b(quiz|test|practice|exam).*\b(chemistry|chemical|stoich|mol|equation|balance)/i,
                /\b(chemistry|chemical|stoich|mol|equation|balance).*\b(quiz|test|practice|exam)/i,
                /can you (help|teach|explain|show)/i,
                /i (want|need|would like) to (learn|understand|know)/i
            ];
            
            const hasChemQuestionPattern = chemQuestionPatterns.some(pattern => pattern.test(lowerMessage));
            
            // If it has chemistry keywords or patterns, it's NOT unrelated
            if (hasChemKeywords || hasChemQuestionPattern) {
                return false;
            }
            
            // Topics that are COMPLETELY unrelated to chemistry/education
            const completelyUnrelatedTopics = [
                /\b(sports|basketball|football|soccer|tennis|volleyball|boxing|mma|ufc)\b/i,
                /\b(politics|government|election|president|mayor|senator|congress)\b/i,
                /\b(movies|films|cinema|netflix|tv shows|series|anime|kdrama)\b/i,
                /\b(music|songs|singer|artist|band|concert|album|spotify)\b/i,
                /\b(food|restaurant|cooking|recipe|pizza|burger|coffee|tea)\b/i,
                /\b(travel|vacation|trip|hotel|flight|airport|beach|mountain)\b/i,
                /\b(shopping|mall|store|buy|sell|price|money|business|work|job)\b/i,
                /\b(weather|rain|sunny|cloudy|storm|typhoon|bagyo)\b/i,
                /\b(gaming|games|mobile legends|cod|pubg|minecraft|roblox)\b/i,
                /\b(social media|facebook|instagram|tiktok|twitter|youtube)\b/i,
                /\b(relationships|love|girlfriend|boyfriend|crush|dating)\b/i,
                /\b(fashion|clothes|shoes|bag|style|outfit)\b/i,
                /\b(cars|motorcycle|driving|license|traffic|transportation)\b/i,
                /\b(health|medicine|doctor|hospital|sick|pain|headache)\b/i,
                /\b(religion|church|prayer|god|bible|mass)\b/i
            ];
            
            // Only return true if it matches completely unrelated topics
            return completelyUnrelatedTopics.some(pattern => pattern.test(lowerMessage));
        }

        function addMessage(content, sender, messageType = 'text') {
            const messageData = {
                id: Date.now().toString(),
                message: content,
                sender: sender,
                timestamp: new Date().toISOString(),
                messageType: messageType,
                userNickname: userProfile.nickname || '',
                userAge: userProfile.age || ''
            };

            if (window.dataSdk && chatHistory.length < 999) {
                window.dataSdk.create(messageData);
            } else if (chatHistory.length >= 999) {
                showMessage('Chat history limit reached. Please refresh to continue.', 'system');
            } else {
                chatHistory.push(messageData);
                renderChatHistory();
            }
        }

        function renderChatHistory() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(typingIndicator);

            chatHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                if (msg.messageType === 'quiz') {
                    contentDiv.innerHTML = msg.message;
                } else {
                    contentDiv.textContent = msg.message;
                }
                
                messageDiv.appendChild(contentDiv);
                messagesContainer.appendChild(messageDiv);
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'block';
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isLoading) return;

            if (!userProfile.isSetup) {
                addMessage("Please complete the welcome form first to start our conversation! 😊", 'bot');
                return;
            }

            isLoading = true;
            document.getElementById('sendBtn').disabled = true;
            
            addMessage(message, 'user');
            input.value = '';
            adjustTextareaHeight(input);

            showTyping();
            
            setTimeout(() => {
                const response = generateBotResponse(message);
                hideTyping();
                addMessage(response.content, 'bot', response.type);
                
                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
                
                // Keep focus on input for mobile
                input.focus();
            }, 1500);
        }

        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        function generateBotResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            const nickname = userProfile.nickname;
            const age = userProfile.age;
            
            // Handle greetings and casual conversation warmly
            const greetingPatterns = [
                /^(hi|hello|hey|good morning|good afternoon|good evening|kamusta|kumusta|musta|sup|what's up|whats up)$/i
            ];
            
            if (greetingPatterns.some(pattern => pattern.test(msg))) {
                const greetings = [
                    `Hello ${nickname}! 👋 I'm so happy to see you! Ready to explore some chemistry today? 🧪✨`,
                    `Hi there ${nickname}! 😊 Great to have you back! What chemistry topic would you like to dive into? ⚗️`,
                    `Hey ${nickname}! 🌟 I'm excited to help you with chemistry today! What's on your mind? 🔬`,
                    `Kamusta ${nickname}! 😄 Ready for another chemistry adventure? I'm here to help! 🧪💫`
                ];
                return {
                    type: 'text',
                    content: greetings[Math.floor(Math.random() * greetings.length)]
                };
            }
            
            // Handle appreciation/thanks
            if (/^(thank you|thanks|salamat|ty|tysm|thank u)$/i.test(msg)) {
                const thankResponses = [
                    `You're very welcome, ${nickname}! 😊 I'm always happy to help you learn chemistry! 🧪`,
                    `Walang anuman, ${nickname}! 💙 That's what I'm here for - to make chemistry fun and easy! ✨`,
                    `My pleasure, ${nickname}! 🌟 Keep asking questions - I love helping you understand chemistry! 🔬`,
                    `Anytime, ${nickname}! 😄 I'm so proud of your curiosity about chemistry! Keep it up! 🎉`
                ];
                return {
                    type: 'text',
                    content: thankResponses[Math.floor(Math.random() * thankResponses.length)]
                };
            }
            
            // Handle "how are you" type questions
            if (/^(how are you|how r u|kamusta ka|okay ka ba|fine ka ba)$/i.test(msg)) {
                const statusResponses = [
                    `I'm doing great, ${nickname}! 😊 I'm always excited when I get to help students learn chemistry! How are you doing today? 🌟`,
                    `I'm fantastic, salamat! 💙 I love helping with stoichiometry - it's my favorite topic! How about you, ready to learn something new? 🧪`,
                    `I'm wonderful, ${nickname}! 🎉 Every day I get to teach chemistry is a good day! What brings you here today? ⚗️`,
                    `I'm doing amazing! 😄 I'm always energized when talking about chemistry! How can I help you today? 🔬`
                ];
                return {
                    type: 'text',
                    content: statusResponses[Math.floor(Math.random() * statusResponses.length)]
                };
            }
            
            // Handle "who are you" questions
            if (/^(who are you|what are you|sino ka|ano ka)$/i.test(msg)) {
                return {
                    type: 'text',
                    content: `I'm StoichBot, ${nickname}! 🤖✨ I'm your friendly AI chemistry tutor who specializes in stoichiometry! I love helping students like you understand the amazing world of chemical calculations, mole concepts, and equation balancing! 🧪

I'm here to make chemistry fun, easy, and engaging for you! Whether you need help with homework, want to practice with quizzes, or just curious about how chemistry works - I'm your guy! 😊

What would you like to explore in chemistry today? 🔬💫`
                };
            }

            // Handle calculator requests with simple approach
            if (msg.includes('calculator') || msg.includes('calc') || 
                msg.includes('balance equations') || msg.includes('balance equation') ||
                msg.includes('equation balancer') || msg.includes('help me balance')) {
                
                showCalculatorSection();
                
                return {
                    type: 'text',
                    content: `Perfect, ${nickname}! 🧮 I've opened the equation balancer for you! 

**How to use it:**
1. Enter your reactants (left side) - like "H2 + O2"
2. Enter your products (right side) - like "H2O" 
3. Click "Balance Equation" to see the balanced result!

**Examples you can try:**
• H2 + O2 → H2O
• C + O2 → CO2  
• CH4 + O2 → CO2 + H2O
• Fe + O2 → Fe2O3

The calculator will show you the balanced equation with step-by-step explanations! Try it now! 🎯✨`
                };
            }
            
            // Handle simple positive responses
            if (/^(nice|cool|great|awesome|amazing|galing|maganda)$/i.test(msg)) {
                const positiveResponses = [
                    `I'm so glad you think so, ${nickname}! 😊 Chemistry really is amazing when you understand it! What else would you like to learn? 🧪`,
                    `Right?! 🎉 Chemistry is full of cool discoveries! I love sharing that excitement with you, ${nickname}! What's next? ⚗️`,
                    `Thank you, ${nickname}! 💙 I'm passionate about making chemistry enjoyable! Ready for more learning? 🔬`,
                    `Salamat, ${nickname}! 😄 That's exactly why I love teaching chemistry - seeing students get excited about it! 🌟`
                ];
                return {
                    type: 'text',
                    content: positiveResponses[Math.floor(Math.random() * positiveResponses.length)]
                };
            }
            
            // Handle help requests
            if (/^(help|tulong|assist)$/i.test(msg)) {
                return {
                    type: 'text',
                    content: `Of course I'll help you, ${nickname}! 💙 That's exactly what I'm here for! 🧪

I can assist you with:
🔹 **Stoichiometry basics** - mole concept, Avogadro's number
🔹 **Balancing equations** - step-by-step with explanations  
🔹 **Problem solving** - mass-to-mass, mole-to-mole conversions
🔹 **Limiting reactants** - finding which runs out first
🔹 **Percent yield** - theoretical vs actual calculations
🔹 **Practice quizzes** - test your knowledge!
🔹 **Interactive calculator** - for equation balancing

What specific chemistry topic would you like help with today? Just ask me anything! 😊✨`
                };
            }
            
            // Only use fallback for COMPLETELY unrelated topics
            if (isCompletelyUnrelated(userMessage)) {
                return {
                    type: 'text',
                    content: `I appreciate you sharing that with me, ${nickname}! 😊 While that sounds interesting, I'm specifically designed to be your chemistry tutor, so I'm most helpful with stoichiometry and chemistry topics! 🧪

I'd love to help you with:
• **Mole concept** and calculations 🔢
• **Balancing chemical equations** ⚖️
• **Stoichiometric problem solving** 🧮
• **Limiting reactants** and excess reactants 🔬
• **Percent yield** calculations 📊
• **Practice quizzes** to test your knowledge 🎯

Is there anything in chemistry you'd like to explore or learn about today? I'm here to make it fun and easy for you! 😄✨`
                };
            }
            
            const quizPatterns = [
                /\b(quiz|test|exam|practice|question)\b/i,
                /take.*\b(quiz|test|exam)\b/i,
                /start.*\b(quiz|test|exam)\b/i,
                /give.*me.*\b(quiz|test|question)\b/i,
                /i.*want.*\b(quiz|test|practice)\b/i,
                /can.*i.*\b(take|have|get).*\b(quiz|test)\b/i
            ];
            
            const isQuizRequest = quizPatterns.some(pattern => pattern.test(msg));
            
            if (isQuizRequest) {
                return {
                    type: 'quiz',
                    content: generateQuizSelector()
                };
            }
            
            const calculatorPatterns = [
                /calculator/i,
                /calc/i
            ];
            
            const hasCalculatorKeyword = calculatorPatterns.some(pattern => pattern.test(msg));
            
            const balancePatterns = [
                /\b(balance|balancing)\b.*\b(equation|reaction|formula)\b/i,
                /\b(equation|reaction|formula)\b.*\b(balance|balancing)\b/i,
                /help.*me.*balance/i,
                /how.*to.*balance/i,
                /balance.*chemical/i,
                /chemical.*balance/i,
                /balance.*equations/i,
                /equation.*balancer/i
            ];
            
            const hasBalanceKeywords = balancePatterns.some(pattern => pattern.test(msg)) || 
                                     (msg.includes('balance') && (msg.includes('equation') || msg.includes('equations'))) ||
                                     msg.includes('help me balance') ||
                                     msg.toLowerCase().includes('balance equations') ||
                                     msg.toLowerCase() === 'balance equations' ||
                                     msg.toLowerCase().includes('equation balancer') ||
                                     msg.toLowerCase().includes('chemical balancer');
            
            // Direct calculator request - show calculator immediately
            if (hasCalculatorKeyword) {
                return {
                    type: 'quiz',
                    content: generateBalanceCalculator()
                };
            }
            
            // Balance equation request - show calculator directly
            if (hasBalanceKeywords) {
                return {
                    type: 'quiz',
                    content: generateBalanceCalculator()
                };
            }
            
            const stoichConceptPatterns = [
                /what.*is.*stoich/i,
                /explain.*stoich/i,
                /stoich.*basic/i,
                /basic.*stoich/i,
                /define.*stoich/i,
                /meaning.*stoich/i,
                /stoich.*mean/i
            ];
            
            const isStoichConcept = stoichConceptPatterns.some(pattern => pattern.test(msg)) ||
                                  msg.includes('what is stoichiometry') || 
                                  msg.includes('stoichiometry basics');
            
            if (isStoichConcept) {
                let explanation = `Great question, ${nickname}! 🧪 Stoichiometry is like the "recipe math" of chemistry!\n\n`;
                
                if (age === '13-15') {
                    explanation += `Think of it like baking cookies 🍪:\n• If 1 cup of flour makes 12 cookies\n• Then 2 cups of flour makes 24 cookies\n\nStoichiometry works the same way with chemical reactions! It helps us figure out how much of each chemical we need, or how much product we'll get.\n\nKey ideas:\n🔹 Chemical equations are like recipes\n🔹 We use ratios to calculate amounts\n🔹 Everything must be balanced (like a balanced meal!)`;
                } else if (age === '16-18') {
                    explanation += `Stoichiometry is the quantitative study of chemical reactions. It's based on the law of conservation of mass - matter cannot be created or destroyed.\n\nCore concepts:\n🔹 Balanced chemical equations show exact ratios\n🔹 Mole ratios from coefficients guide calculations\n🔹 Convert between grams, moles, and molecules\n🔹 Predict amounts of reactants needed or products formed\n\nExample: 2H₂ + O₂ → 2H₂O\nThis tells us 2 moles H₂ react with 1 mole O₂ to make 2 moles H₂O`;
                } else {
                    explanation += `Stoichiometry is the quantitative relationship between reactants and products in chemical reactions, governed by conservation laws.\n\nFundamental principles:\n🔹 Conservation of mass and atoms\n🔹 Definite proportions in chemical compounds\n🔹 Mole concept as the bridge between atomic and macroscopic scales\n🔹 Stoichiometric coefficients define molar ratios\n\nApplications include:\n• Industrial process optimization\n• Environmental impact calculations\n• Pharmaceutical dosage determinations\n• Materials science applications`;
                }
                
                return { type: 'text', content: explanation };
            }
            
            // Enhanced response generation using MASSIVE knowledge base
            return generateUltraEnhancedResponse(userMessage, nickname, age);
        }
        
        function generateUltraEnhancedResponse(userMessage, nickname, age) {
            const msg = userMessage.toLowerCase();
            
            // COMPREHENSIVE CONCEPT MATCHING - COVERS ALL STOICHIOMETRY TOPICS
            
            // Check for ANY concept in our knowledge base
            for (const [conceptKey, conceptValue] of Object.entries(stoichiometryKnowledge.concepts)) {
                // Multiple ways to match concepts
                const conceptMatches = [
                    msg.includes(conceptKey.toLowerCase()),
                    msg.includes(conceptKey.replace(/([A-Z])/g, ' $1').toLowerCase().trim()), // camelCase to spaces
                    conceptKey.toLowerCase().split(/(?=[A-Z])/).some(part => msg.includes(part)), // partial matches
                ];
                
                // Special keyword mappings for common variations
                const keywordMappings = {
                    'mole': ['mol', 'moles', 'molar'],
                    'avogadro': ['avogadros', 'avogadro number', 'avogadros number'],
                    'molarmass': ['molecular weight', 'formula weight', 'atomic weight'],
                    'limitingreactant': ['limiting reagent', 'limiting', 'runs out first'],
                    'excessreactant': ['excess reagent', 'excess', 'leftover'],
                    'percentyield': ['percent yield', '% yield', 'efficiency'],
                    'theoreticalyield': ['theoretical yield', 'maximum yield'],
                    'actualyield': ['actual yield', 'experimental yield'],
                    'molarity': ['concentration', 'molar concentration'],
                    'molality': ['molal concentration'],
                    'idealgaslaw': ['ideal gas', 'pv=nrt', 'gas law'],
                    'stp': ['standard temperature pressure', 'standard conditions'],
                    'equilibriumconstant': ['equilibrium', 'keq', 'k constant'],
                    'reactionrate': ['rate of reaction', 'kinetics'],
                    'enthalpy': ['heat of reaction', 'delta h'],
                    'faradayslaw': ['electrolysis', 'faraday'],
                    'osmosis': ['osmotic pressure'],
                    'freezingpoint': ['freezing point depression'],
                    'boilingpoint': ['boiling point elevation']
                };
                
                // Check keyword mappings
                if (keywordMappings[conceptKey]) {
                    conceptMatches.push(...keywordMappings[conceptKey].map(keyword => msg.includes(keyword)));
                }
                
                if (conceptMatches.some(match => match)) {
                    return generateConceptResponse(conceptKey, conceptValue, nickname, age);
                }
            }
            
            // ADVANCED PATTERN MATCHING FOR COMPLEX QUERIES
            
            // Gas law calculations
            if (msg.match(/\b(pressure|volume|temperature|gas|pv|nrt|atm|kpa|celsius|kelvin)\b/)) {
                return generateGasLawResponse(nickname, age);
            }
            
            // Solution chemistry
            if (msg.match(/\b(solution|solute|solvent|dissolve|concentration|dilution|m1v1|m2v2)\b/)) {
                return generateSolutionResponse(nickname, age);
            }
            
            // Thermochemistry
            if (msg.match(/\b(energy|heat|enthalpy|exothermic|endothermic|calorimetry|joule|calorie)\b/)) {
                return generateThermochemistryResponse(nickname, age);
            }
            
            // Electrochemistry
            if (msg.match(/\b(electrode|cathode|anode|electron|current|voltage|battery|cell)\b/)) {
                return generateElectrochemistryResponse(nickname, age);
            }
            
            // Nuclear chemistry
            if (msg.match(/\b(nuclear|radioactive|decay|fission|fusion|isotope|radiation|half.?life)\b/)) {
                return generateNuclearResponse(nickname, age);
            }
            
            // Organic chemistry
            if (msg.match(/\b(organic|hydrocarbon|alkane|alkene|alcohol|acid|ester|polymer)\b/)) {
                return generateOrganicResponse(nickname, age);
            }
            
            // Environmental chemistry
            if (msg.match(/\b(pollution|acid.?rain|ozone|greenhouse|carbon.?dioxide|climate)\b/)) {
                return generateEnvironmentalResponse(nickname, age);
            }
            
            // Biochemistry
            if (msg.match(/\b(enzyme|protein|dna|metabolism|fermentation|photosynthesis|respiration)\b/)) {
                return generateBiochemistryResponse(nickname, age);
            }
            
            // Industrial processes
            if (msg.match(/\b(industrial|factory|production|manufacturing|haber|contact|ostwald)\b/)) {
                return generateIndustrialResponse(nickname, age);
            }
            
            // Analytical chemistry
            if (msg.match(/\b(analysis|spectroscopy|chromatography|titration|indicator|ph)\b/)) {
                return generateAnalyticalResponse(nickname, age);
            }
            
            // Crystal chemistry
            if (msg.match(/\b(crystal|lattice|unit.?cell|packing|solid.?state|x.?ray)\b/)) {
                return generateCrystalResponse(nickname, age);
            }
            
            // Default comprehensive response
            return {
                type: 'text',
                content: `I have extensive knowledge about that topic, ${nickname}! 🧪 My database covers:\n\n**FUNDAMENTAL CONCEPTS:**\n• Mole concept, Avogadro's number, molar mass\n• Stoichiometric calculations and conversions\n• Limiting reactants, excess reactants, percent yield\n\n**ADVANCED TOPICS:**\n• Gas laws (PV=nRT), solution chemistry, thermochemistry\n• Electrochemistry, nuclear chemistry, organic reactions\n• Environmental chemistry, biochemical processes\n• Industrial applications, analytical methods\n\n**SPECIALIZED AREAS:**\n• Crystallography, polymer chemistry, surface chemistry\n• Colligative properties, equilibrium, kinetics\n• Spectroscopy, chromatography, and more!\n\nI can explain any of these topics at your level (${age} years). What specific aspect would you like to explore? 😊✨`
            };
        }
        
        function generateConceptResponse(conceptKey, conceptValue, nickname, age) {
            let response = `Excellent question about ${conceptKey.replace(/([A-Z])/g, ' $1').toLowerCase()}, ${nickname}! 🧪\n\n`;
            response += conceptValue + '\n\n';
            
            // Age-appropriate explanations for each concept
            const ageSpecificContent = {
                'mole': {
                    '13-15': `**Think of it like counting! 🔢**\n• 1 dozen = 12 items\n• 1 gross = 144 items\n• 1 mole = 6.022 × 10²³ particles\n\nJust like we use "dozen" for eggs, chemists use "mole" for atoms and molecules!\n\n**Examples:**\n• 1 mole of carbon atoms = 12 grams\n• 1 mole of water molecules = 18 grams`,
                    '16-18': `**Key Relationships:**\n• n = m/M (moles = mass/molar mass)\n• N = n × Nₐ (particles = moles × Avogadro's number)\n• At STP: V = n × 22.4 L (for gases)\n\n**Practice:**\nHow many molecules in 36g of water?\n• n = 36g ÷ 18g/mol = 2 mol\n• N = 2 mol × 6.022×10²³ = 1.204×10²⁴ molecules`,
                    '19+': `**Advanced Applications:**\n• Molarity: M = n/V (mol/L)\n• Ideal gas law: PV = nRT\n• Thermodynamic calculations: ΔH = n × ΔH°\n• Kinetic theory: rate ∝ [concentration]\n\n**Industrial Relevance:**\n• Process design and optimization\n• Quality control in manufacturing\n• Environmental impact assessments`
                },
                'avogadro': {
                    '13-15': `**Amazing Facts! 🤯**\n• 6.022 × 10²³ is HUGE!\n• If you counted 1 number per second, it would take 1.9 × 10¹⁶ years!\n• That's longer than the universe has existed!\n\n**Memory Trick:**\n• "Avocado's number" - imagine 6.022 × 10²³ avocados! 🥑`,
                    '16-18': `**Historical Context:**\n• Named after Amedeo Avogadro (1776-1856)\n• Determined through multiple experimental methods\n• Links atomic scale to macroscopic world\n\n**Experimental Determination:**\n• X-ray crystallography\n• Electrolysis experiments\n• Brownian motion studies`,
                    '19+': `**Precise Value:** 6.02214076 × 10²³ mol⁻¹\n• Defined exactly since 2019 SI redefinition\n• Fundamental physical constant\n• Enables quantitative chemistry\n\n**Research Applications:**\n• Single-molecule studies\n• Nanotechnology\n• Quantum chemistry calculations`
                }
                // Add more concepts as needed...
            };
            
            const ageGroup = age === '13-15' ? '13-15' : age === '16-18' ? '16-18' : '19+';
            if (ageSpecificContent[conceptKey] && ageSpecificContent[conceptKey][ageGroup]) {
                response += ageSpecificContent[conceptKey][ageGroup];
            }
            
            return { type: 'text', content: response };
        }
        
        function generateGasLawResponse(nickname, age) {
            let response = `Great question about gas laws, ${nickname}! 🌬️\n\n`;
            
            if (age === '13-15') {
                response += `**Gas Laws Made Simple:**\n\n**Boyle's Law:** P₁V₁ = P₂V₂\n• Squeeze a balloon → pressure goes up, volume goes down\n• Like squeezing a sponge! 🧽\n\n**Charles's Law:** V₁/T₁ = V₂/T₂\n• Heat a balloon → it gets bigger\n• Cool it down → it shrinks\n\n**Combined Gas Law:** P₁V₁/T₁ = P₂V₂/T₂\n• Combines both effects!`;
            } else if (age === '16-18') {
                response += `**Ideal Gas Law:** PV = nRT\n• P = pressure (atm, kPa, mmHg)\n• V = volume (L)\n• n = moles\n• R = 0.08206 L·atm/mol·K\n• T = temperature (Kelvin!)\n\n**At STP:** 1 mole gas = 22.4 L\n**At SATP:** 1 mole gas = 24.5 L\n\n**Example:**\nWhat volume does 2.5 mol CO₂ occupy at 25°C and 1.2 atm?\nV = nRT/P = (2.5)(0.08206)(298)/1.2 = 50.8 L`;
            } else {
                response += `**Advanced Gas Behavior:**\n\n**Real Gas Corrections:**\n• van der Waals equation: (P + a/V²)(V - b) = RT\n• Compressibility factor: Z = PV/nRT\n\n**Applications:**\n• Industrial process design\n• Atmospheric chemistry\n• Respiratory physiology\n• Scuba diving calculations\n\n**Non-ideal Behavior:**\n• High pressure → intermolecular forces\n• Low temperature → molecular volume effects`;
            }
            
            return { type: 'text', content: response };
        }
        
        function generateSolutionResponse(nickname, age) {
            let response = `Perfect question about solutions, ${nickname}! 🧪💧\n\n`;
            
            if (age === '13-15') {
                response += `**Solutions Basics:**\n\n**What's a solution?**\n• Solute (what dissolves) + Solvent (what it dissolves in)\n• Like sugar (solute) in water (solvent) = sweet water! 🍯\n\n**Concentration:**\n• More solute = stronger solution\n• Less solute = weaker solution\n• Like making juice - more powder = stronger taste!`;
            } else if (age === '16-18') {
                response += `**Concentration Units:**\n\n**Molarity (M):** moles solute / L solution\n• Most common in chemistry\n• M = n/V\n\n**Dilution:** M₁V₁ = M₂V₂\n• Adding water decreases concentration\n\n**Example:**\nHow to make 500 mL of 0.1 M NaCl from 1.0 M stock?\nM₁V₁ = M₂V₂\n(1.0 M)(V₁) = (0.1 M)(500 mL)\nV₁ = 50 mL stock + 450 mL water`;
            } else {
                response += `**Advanced Solution Chemistry:**\n\n**Concentration Units:**\n• Molarity (M): mol/L solution\n• Molality (m): mol/kg solvent\n• Mole fraction (χ): mol component/total mol\n• Parts per million (ppm): mg/L\n\n**Colligative Properties:**\n• Vapor pressure lowering: ΔP = χ_solute × P°\n• Freezing point depression: ΔTf = Kf × m × i\n• Boiling point elevation: ΔTb = Kb × m × i\n• Osmotic pressure: π = MRT\n\n**Applications:**\n• Pharmaceutical formulations\n• Environmental monitoring\n• Food science\n• Biological systems`;
            }
            
            return { type: 'text', content: response };
        }
        
        function generateThermochemistryResponse(nickname, age) {
            return {
                type: 'text',
                content: `Fascinating topic about energy in reactions, ${nickname}! 🔥❄️\n\n${stoichiometryKnowledge.concepts.enthalpy}\n\n**Key Concepts:**\n• Exothermic: releases heat (ΔH negative)\n• Endothermic: absorbs heat (ΔH positive)\n• Hess's Law: total ΔH independent of pathway\n\n**Applications:**\n• Fuel efficiency calculations\n• Food calorie content\n• Industrial process design\n• Climate change studies\n\nWant to explore specific thermochemical calculations? 🌡️⚗️`
            };
        }
        
        function generateElectrochemistryResponse(nickname, age) {
            return {
                type: 'text',
                content: `Exciting topic about electrons and electricity, ${nickname}! ⚡🔋\n\n${stoichiometryKnowledge.concepts.faradayslaw}\n\n**Key Processes:**\n• Electrolysis: electricity drives reactions\n• Galvanic cells: reactions produce electricity\n• Corrosion: unwanted redox reactions\n\n**Applications:**\n• Battery technology\n• Metal plating and refining\n• Fuel cells\n• Corrosion prevention\n\nInterested in specific electrochemical calculations? 🧪⚡`
            };
        }
        
        function generateNuclearResponse(nickname, age) {
            return {
                type: 'text',
                content: `Incredible topic about nuclear processes, ${nickname}! ☢️⚛️\n\n${stoichiometryKnowledge.concepts.radioactivedecay}\n\n**Nuclear Reactions:**\n• Fission: heavy nuclei split\n• Fusion: light nuclei combine\n• Decay: unstable nuclei emit radiation\n\n**Applications:**\n• Nuclear power generation\n• Medical imaging and treatment\n• Carbon dating\n• Nuclear weapons (unfortunately)\n\nWant to explore nuclear calculations or safety? 🔬☢️`
            };
        }
        
        function generateOrganicResponse(nickname, age) {
            return {
                type: 'text',
                content: `Awesome question about organic chemistry, ${nickname}! 🧬💊\n\nOrganic chemistry deals with carbon-containing compounds - the chemistry of life!\n\n**Major Reaction Types:**\n• Substitution: replace one group with another\n• Addition: add across double/triple bonds\n• Elimination: remove groups to form multiple bonds\n• Rearrangement: atoms reorganize within molecule\n\n**Applications:**\n• Pharmaceuticals and medicines\n• Plastics and polymers\n• Fuels and energy\n• Food chemistry and flavors\n\nInterested in specific organic reactions or mechanisms? 🧪🔬`
            };
        }
        
        function generateEnvironmentalResponse(nickname, age) {
            return {
                type: 'text',
                content: `Important topic about environmental chemistry, ${nickname}! 🌍🌱\n\n${stoichiometryKnowledge.concepts.carbondioxide}\n\n**Environmental Issues:**\n• Greenhouse effect and climate change\n• Ozone depletion\n• Acid rain formation\n• Water and air pollution\n\n**Chemical Solutions:**\n• Catalytic converters in cars\n• Carbon capture technologies\n• Green chemistry principles\n• Renewable energy systems\n\nWant to explore specific environmental calculations? 🌿⚗️`
            };
        }
        
        function generateBiochemistryResponse(nickname, age) {
            return {
                type: 'text',
                content: `Fascinating topic about the chemistry of life, ${nickname}! 🧬🔬\n\n${stoichiometryKnowledge.concepts.enzymekinetics}\n\n**Biological Processes:**\n• Photosynthesis: CO₂ + H₂O → glucose + O₂\n• Cellular respiration: glucose + O₂ → CO₂ + H₂O + ATP\n• Fermentation: glucose → alcohol or lactic acid\n• Protein synthesis: amino acids → proteins\n\n**Applications:**\n• Medicine and drug design\n• Biotechnology and genetic engineering\n• Food science and nutrition\n• Agricultural chemistry\n\nInterested in specific biochemical pathways? 🧪🧬`
            };
        }
        
        function generateIndustrialResponse(nickname, age) {
            return {
                type: 'text',
                content: `Excellent question about industrial chemistry, ${nickname}! 🏭⚗️\n\n**Major Industrial Processes:**\n• Haber process: N₂ + 3H₂ → 2NH₃ (fertilizers)\n• Contact process: SO₂ + O₂ → SO₃ → H₂SO₄ (sulfuric acid)\n• Ostwald process: NH₃ → NO → HNO₃ (nitric acid)\n• Blast furnace: Fe₂O₃ + C → Fe + CO₂ (iron/steel)\n\n**Key Considerations:**\n• Economic optimization\n• Environmental impact\n• Safety requirements\n• Energy efficiency\n\n**Applications:**\n• Chemical manufacturing\n• Petroleum refining\n• Pharmaceutical production\n• Materials science\n\nWant to explore specific industrial calculations? 🏗️🧪`
            };
        }
        
        function generateAnalyticalResponse(nickname, age) {
            return {
                type: 'text',
                content: `Great question about analytical chemistry, ${nickname}! 🔍📊\n\n${stoichiometryKnowledge.concepts.spectrophotometry}\n\n**Analytical Techniques:**\n• Titrations: determine concentration\n• Spectroscopy: identify compounds\n• Chromatography: separate mixtures\n• Mass spectrometry: determine molecular weight\n\n**Applications:**\n• Quality control in manufacturing\n• Environmental monitoring\n• Medical diagnostics\n• Forensic science\n\n**Quantitative Analysis:**\n• Gravimetric analysis (mass-based)\n• Volumetric analysis (volume-based)\n• Instrumental analysis (instrument-based)\n\nInterested in specific analytical calculations? 🧪📈`
            };
        }
        
        function generateCrystalResponse(nickname, age) {
            return {
                type: 'text',
                content: `Fascinating topic about crystal chemistry, ${nickname}! 💎🔬\n\n${stoichiometryKnowledge.concepts.unitcell}\n\n**Crystal Structures:**\n• Simple cubic (SC): 52% packing efficiency\n• Body-centered cubic (BCC): 68% packing\n• Face-centered cubic (FCC): 74% packing\n• Hexagonal close-packed (HCP): 74% packing\n\n**Applications:**\n• Materials science and engineering\n• Semiconductor technology\n• Pharmaceutical polymorphs\n• Geological studies\n\n**Analysis Methods:**\n• X-ray crystallography\n• Electron diffraction\n• Neutron scattering\n\nWant to explore crystal calculations or structures? 💎⚗️`
            };
        }

        function generateQuizSelector() {
            const selectorId = Date.now();
            
            return `
                <div class="quiz-selector-container">
                    <div class="quiz-selector-header">
                        <h3>🎯 Choose Your Quiz Settings</h3>
                        <p>Select difficulty level and number of questions:</p>
                    </div>
                    
                    <div class="quiz-settings">
                        <div class="setting-group">
                            <label>Difficulty Level:</label>
                            <div class="difficulty-options">
                                <button class="difficulty-btn" onclick="selectDifficulty('easy', this, ${selectorId})">📚 Easy</button>
                                <button class="difficulty-btn" onclick="selectDifficulty('normal', this, ${selectorId})">🧪 Normal</button>
                                <button class="difficulty-btn" onclick="selectDifficulty('hard', this, ${selectorId})">🔬 Hard</button>
                                <button class="difficulty-btn" onclick="selectDifficulty('extreme', this, ${selectorId})">⚗️ Extreme</button>
                            </div>
                        </div>
                        
                        <div class="setting-group">
                            <label>Number of Questions:</label>
                            <div class="question-count-options">
                                <button class="count-btn" onclick="selectQuestionCount(5, this, ${selectorId})">5 Questions</button>
                                <button class="count-btn" onclick="selectQuestionCount(10, this, ${selectorId})">10 Questions</button>
                                <button class="count-btn" onclick="selectQuestionCount(15, this, ${selectorId})">15 Questions</button>
                                <button class="count-btn" onclick="selectQuestionCount(20, this, ${selectorId})">20 Questions</button>
                            </div>
                        </div>
                        
                        <button class="start-quiz-btn" id="startQuizBtn${selectorId}" onclick="startCustomQuiz(${selectorId})" disabled>
                            🚀 Start Quiz
                        </button>
                    </div>
                    
                    <input type="hidden" id="selectedDifficulty${selectorId}">
                    <input type="hidden" id="selectedCount${selectorId}">
                </div>
            `;
        }

        function generateBalanceCalculator() {
            const calcId = Date.now();
            
            return `
                <div class="balance-calculator-container">
                    <div class="calculator-header">
                        <h3>⚖️ Chemical Equation Balancer</h3>
                        <p>Enter your chemical equation and I'll balance it for you!</p>
                    </div>
                    
                    <div class="equation-input-section">
                        <div class="input-group">
                            <label>Reactants (left side):</label>
                            <input type="text" id="reactants${calcId}" class="equation-input" placeholder="e.g., H2 + O2" />
                        </div>
                        
                        <div class="arrow-symbol">→</div>
                        
                        <div class="input-group">
                            <label>Products (right side):</label>
                            <input type="text" id="products${calcId}" class="equation-input" placeholder="e.g., H2O" />
                        </div>
                    </div>
                    
                    <div class="calculator-buttons">
                        <button class="balance-btn" onclick="balanceEquation(${calcId})">⚖️ Balance Equation</button>
                        <button class="clear-btn" onclick="clearCalculator(${calcId})">🗑️ Clear</button>
                    </div>
                    
                    <div class="result-section" id="balanceResult${calcId}" style="display: none;">
                        <div class="balanced-equation" id="balancedEq${calcId}"></div>
                        <div class="explanation" id="explanation${calcId}"></div>
                    </div>
                    
                    <div class="calculator-help">
                        <h4>💡 How to use:</h4>
                        <ul>
                            <li>Use element symbols (H, O, C, N, etc.)</li>
                            <li>Use numbers for subscripts (H2O, CO2)</li>
                            <li>Separate compounds with + (plus sign)</li>
                            <li>Example: "C + O2" → "CO2"</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // NEW: Function to show calculator in a separate section
        function showCalculatorSection() {
            // Create calculator section if it doesn't exist
            let calcSection = document.getElementById('calculatorSection');
            if (!calcSection) {
                calcSection = document.createElement('div');
                calcSection.id = 'calculatorSection';
                calcSection.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    z-index: 3000;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    padding: 0;
                `;
                document.body.appendChild(calcSection);
            }

            const calcId = 'main';
            calcSection.innerHTML = `
                <div style="position: sticky; top: 0; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">⚖️ Chemical Equation Balancer</h3>
                    <button onclick="closeCalculatorSection()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 50%;">×</button>
                </div>
                
                <div style="padding: 20px;">
                    <p style="margin: 0 0 20px 0; color: #666;">Enter your chemical equation and I'll balance it for you!</p>
                    
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px;">Reactants (left side):</label>
                            <input type="text" id="reactants${calcId}" style="width: 100%; padding: 12px 16px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; font-family: 'Courier New', monospace; box-sizing: border-box;" placeholder="e.g., H2 + O2" />
                        </div>
                        
                        <div style="font-size: 24px; font-weight: bold; color: #007bff; margin: 0 10px;">→</div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px;">Products (right side):</label>
                            <input type="text" id="products${calcId}" style="width: 100%; padding: 12px 16px; border: 2px solid #dee2e6; border-radius: 10px; font-size: 16px; font-family: 'Courier New', monospace; box-sizing: border-box;" placeholder="e.g., H2O" />
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="balanceEquation('${calcId}')" style="padding: 12px 20px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; background: #28a745; color: white;">⚖️ Balance Equation</button>
                        <button onclick="clearCalculator('${calcId}')" style="padding: 12px 20px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; background: #6c757d; color: white;">🗑️ Clear</button>
                    </div>
                    
                    <div id="balanceResult${calcId}" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #dee2e6;">
                        <div id="balancedEq${calcId}"></div>
                        <div id="explanation${calcId}"></div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e9ecef; border-radius: 10px;">
                        <h4 style="margin: 0 0 10px 0; color: #495057; font-size: 16px;">💡 How to use:</h4>
                        <ul style="margin: 0; padding-left: 20px;">
                            <li style="margin-bottom: 5px; color: #6c757d;">Use element symbols (H, O, C, N, etc.)</li>
                            <li style="margin-bottom: 5px; color: #6c757d;">Use numbers for subscripts (H2O, CO2)</li>
                            <li style="margin-bottom: 5px; color: #6c757d;">Separate compounds with + (plus sign)</li>
                            <li style="color: #6c757d;">Example: "C + O2" → "CO2"</li>
                        </ul>
                    </div>
                </div>
            `;

            // Show the calculator
            calcSection.style.display = 'block';
            
            // Add backdrop
            let backdrop = document.getElementById('calcBackdrop');
            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.id = 'calcBackdrop';
                backdrop.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 2999;
                `;
                backdrop.onclick = closeCalculatorSection;
                document.body.appendChild(backdrop);
            }
            backdrop.style.display = 'block';
        }

        function closeCalculatorSection() {
            const calcSection = document.getElementById('calculatorSection');
            const backdrop = document.getElementById('calcBackdrop');
            if (calcSection) calcSection.style.display = 'none';
            if (backdrop) backdrop.style.display = 'none';
        }

        // Balance calculator functions
        function balanceEquation(calcId) {
            const reactants = document.getElementById(`reactants${calcId}`).value.trim();
            const products = document.getElementById(`products${calcId}`).value.trim();
            
            if (!reactants || !products) {
                document.getElementById(`balanceResult${calcId}`).innerHTML = `
                    <div class="error-message">⚠️ Please enter both reactants and products!</div>
                `;
                document.getElementById(`balanceResult${calcId}`).style.display = 'block';
                return;
            }
            
            const balancedResult = performBalancing(reactants, products);
            
            document.getElementById(`balancedEq${calcId}`).innerHTML = `
                <div class="balanced-result">
                    <h4>✅ Balanced Equation:</h4>
                    <div class="equation-display">${balancedResult.equation}</div>
                </div>
            `;
            
            document.getElementById(`explanation${calcId}`).innerHTML = `
                <div class="balance-explanation">
                    <h4>📝 Explanation:</h4>
                    <p>${balancedResult.explanation}</p>
                    <div class="steps">
                        <h5>Steps taken:</h5>
                        <ol>
                            ${balancedResult.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            `;
            
            document.getElementById(`balanceResult${calcId}`).style.display = 'block';
        }

        function clearCalculator(calcId) {
            document.getElementById(`reactants${calcId}`).value = '';
            document.getElementById(`products${calcId}`).value = '';
            document.getElementById(`balanceResult${calcId}`).style.display = 'none';
        }

        // ULTRA-COMPREHENSIVE STOICHIOMETRY KNOWLEDGE BASE
        const stoichiometryKnowledge = {
            // ALL STOICHIOMETRY CONCEPTS - FROM BASIC TO EXTREMELY ADVANCED
            concepts: {
                // FUNDAMENTAL CONCEPTS
                stoichiometry: "Stoichiometry is the calculation of quantities in chemical reactions based on the balanced chemical equation. It comes from Greek words 'stoicheion' (element) and 'metron' (measure). It encompasses all quantitative aspects of chemistry including atomic ratios, molecular compositions, and reaction yields.",
                mole: "A mole is the amount of substance containing exactly 6.02214076 × 10²³ elementary entities (Avogadro's number). It's the SI base unit for amount of substance and serves as the bridge between the atomic/molecular scale and the macroscopic world.",
                avogadro: "Avogadro's number (6.02214076 × 10²³) represents the number of particles in one mole of any substance. Named after Amedeo Avogadro, this constant connects atomic mass units to grams and enables stoichiometric calculations.",
                molarmass: "Molar mass is the mass of one mole of a substance, expressed in g/mol. It numerically equals the atomic/molecular weight and is fundamental for converting between mass and moles in stoichiometric calculations.",
                
                // ADVANCED MOLE CONCEPTS
                molarity: "Molarity (M) is the concentration of a solution expressed as moles of solute per liter of solution. M = n/V, where n is moles and V is volume in liters.",
                molality: "Molality (m) is the concentration expressed as moles of solute per kilogram of solvent. Unlike molarity, molality is temperature-independent.",
                normality: "Normality (N) is the number of gram equivalent weights of solute per liter of solution. N = M × number of H⁺ or OH⁻ ions.",
                molefraction: "Mole fraction (χ) is the ratio of moles of one component to total moles in a mixture. χₐ = nₐ/n_total. Sum of all mole fractions equals 1.",
                partialpressure: "Partial pressure is the pressure exerted by individual gases in a mixture. Related to mole fraction by Dalton's Law: Pₐ = χₐ × P_total.",
                
                // REACTION STOICHIOMETRY
                limitingreactant: "The limiting reactant (limiting reagent) is the reactant that is completely consumed first, thereby limiting the amount of product that can be formed. It determines the theoretical yield.",
                excessreactant: "The excess reactant is the reactant that remains after the limiting reactant is completely consumed. The amount of excess can be calculated stoichiometrically.",
                theoreticalyield: "Theoretical yield is the maximum amount of product that can be formed from given amounts of reactants, assuming 100% conversion and no side reactions.",
                actualyield: "Actual yield is the amount of product actually obtained in a reaction, which is typically less than theoretical yield due to various factors.",
                percentyield: "Percent yield = (Actual yield / Theoretical yield) × 100%. It measures the efficiency of a chemical reaction.",
                
                // ADVANCED YIELD CONCEPTS
                atomeconomy: "Atom economy = (Molecular weight of desired product / Sum of molecular weights of all reactants) × 100%. It measures how efficiently atoms are utilized.",
                selectivity: "Selectivity measures the preference for forming one product over others in reactions with multiple possible products. Can be expressed as molar selectivity or conversion selectivity.",
                conversion: "Conversion is the fraction of limiting reactant that reacts. Conversion = (moles reacted / initial moles) × 100%.",
                spacetimeyield: "Space-time yield is the amount of product formed per unit reactor volume per unit time. Important in industrial process design.",
                
                // GAS STOICHIOMETRY
                idealgaslaw: "PV = nRT, where P is pressure, V is volume, n is moles, R is gas constant (0.08206 L·atm/mol·K), and T is temperature in Kelvin.",
                stp: "Standard Temperature and Pressure: 0°C (273.15 K) and 1 atm pressure. At STP, 1 mole of any ideal gas occupies 22.414 L.",
                satp: "Standard Ambient Temperature and Pressure: 25°C (298.15 K) and 1 bar pressure. At SATP, 1 mole of gas occupies 24.465 L.",
                daltonslaw: "Dalton's Law: Total pressure of gas mixture equals sum of partial pressures. P_total = P₁ + P₂ + P₃ + ...",
                grahamslaw: "Graham's Law: Rate of effusion is inversely proportional to square root of molar mass. r₁/r₂ = √(M₂/M₁).",
                
                // SOLUTION STOICHIOMETRY
                dilution: "Dilution formula: M₁V₁ = M₂V₂, where M is molarity and V is volume. Used when adding solvent to decrease concentration.",
                titration: "Titration is a quantitative analytical technique to determine concentration by reacting with a solution of known concentration (standard).",
                equivalencepoint: "Equivalence point is when moles of titrant equal moles of analyte (for 1:1 reactions). Detected by indicators or pH meters.",
                endpoint: "Endpoint is the observed point where indicator changes color, ideally matching the equivalence point.",
                
                // THERMOCHEMICAL STOICHIOMETRY
                enthalpy: "Enthalpy (H) is the heat content of a system. ΔH represents heat absorbed or released during reactions at constant pressure.",
                hesslaw: "Hess's Law: Total enthalpy change is independent of pathway. ΔH_total = ΔH₁ + ΔH₂ + ΔH₃ + ...",
                bondenthalpy: "Bond enthalpy is energy required to break one mole of bonds in gaseous molecules. Used to calculate reaction enthalpies.",
                formationenthalpy: "Standard enthalpy of formation (ΔH°f) is enthalpy change when 1 mole of compound forms from elements in standard states.",
                
                // ELECTROCHEMICAL STOICHIOMETRY
                faradayslaw: "Faraday's Laws relate amount of substance produced at electrodes to electric charge passed. n = Q/(nF), where F = 96,485 C/mol.",
                coulomb: "Coulomb (C) is unit of electric charge. 1 Faraday = 96,485 C = charge of 1 mole of electrons.",
                electrolysis: "Electrolysis uses electric current to drive non-spontaneous chemical reactions. Amount of product depends on current and time.",
                
                // ADVANCED EQUILIBRIUM CONCEPTS
                equilibriumconstant: "Equilibrium constant (K) relates concentrations of products and reactants at equilibrium. K = [products]/[reactants].",
                lechatelier: "Le Chatelier's Principle: System at equilibrium responds to stress by shifting to counteract the change.",
                reactionquotient: "Reaction quotient (Q) has same form as K but uses any concentrations, not just equilibrium values.",
                
                // KINETIC STOICHIOMETRY
                reactionrate: "Reaction rate is change in concentration per unit time. Rate = -Δ[reactant]/Δt = +Δ[product]/Δt.",
                ratelaw: "Rate law expresses reaction rate as function of concentrations: Rate = k[A]^m[B]^n, where k is rate constant.",
                halflife: "Half-life (t₁/₂) is time required for concentration to decrease to half its initial value.",
                
                // COMPLEX STOICHIOMETRY
                consecutivereactions: "Sequential reactions where product of first reaction becomes reactant of second: A → B → C.",
                parallelreactions: "Competing reactions where same reactant forms different products: A → B and A → C.",
                reversiblereactions: "Reactions that proceed in both directions: A + B ⇌ C + D.",
                catalysis: "Catalysts increase reaction rate without being consumed. They don't affect stoichiometry but influence kinetics.",
                
                // INDUSTRIAL STOICHIOMETRY
                processyield: "Overall yield in multi-step industrial processes. Overall yield = (yield₁ × yield₂ × yield₃ × ...).",
                recycle: "Recycling unreacted materials back to reactor to improve overall conversion and atom economy.",
                purge: "Removing portion of recycle stream to prevent accumulation of inerts or byproducts.",
                
                // ANALYTICAL STOICHIOMETRY
                gravimetricanalysis: "Quantitative analysis based on mass measurements. Analyte converted to weighable form.",
                volumetricanalysis: "Quantitative analysis based on volume measurements, typically titrations.",
                spectrophotometry: "Analysis using Beer's Law: A = εbc, where A is absorbance, ε is molar absorptivity, b is path length, c is concentration.",
                
                // BIOCHEMICAL STOICHIOMETRY
                enzymekinetics: "Michaelis-Menten kinetics: v = (V_max[S])/(K_m + [S]), where v is rate, V_max is maximum rate, K_m is Michaelis constant.",
                respiratoryquotient: "RQ = CO₂ produced / O₂ consumed. Indicates type of substrate being metabolized.",
                
                // ENVIRONMENTAL STOICHIOMETRY
                carbondioxide: "Atmospheric CO₂ calculations for climate studies. 1 ppm CO₂ ≈ 2.13 GtC (gigatons carbon).",
                ozonedelpletion: "Stoichiometry of ozone destruction: O₃ + Cl → ClO + O₂, then ClO + O → Cl + O₂.",
                
                // NUCLEAR STOICHIOMETRY
                radioactivedecay: "N(t) = N₀e^(-λt), where λ is decay constant. Related to half-life: t₁/₂ = ln(2)/λ.",
                nuclearreactions: "Mass-energy equivalence: E = mc². Mass defect converted to binding energy.",
                
                // CRYSTALLOGRAPHIC STOICHIOMETRY
                unitcell: "Smallest repeating unit in crystal lattice. Contains specific number of atoms/molecules.",
                packingefficiency: "Fraction of space occupied by atoms in crystal structure. FCC = 74%, BCC = 68%, SC = 52%.",
                
                // POLYMER STOICHIOMETRY
                degreeofpolymerization: "Number of monomer units in polymer chain. DP = M_n/M_monomer.",
                polydispersity: "Measure of molecular weight distribution in polymers. PDI = M_w/M_n.",
                
                // SURFACE CHEMISTRY STOICHIOMETRY
                adsorption: "Langmuir isotherm: θ = (bP)/(1 + bP), where θ is coverage, b is adsorption constant, P is pressure.",
                bet: "BET equation for multilayer adsorption: V/V_m = (cP)/((P₀-P)(1+(c-1)P/P₀)).",
                
                // COLLIGATIVE PROPERTIES
                osmosis: "Osmotic pressure: π = MRT, where M is molarity, R is gas constant, T is temperature.",
                freezingpoint: "Freezing point depression: ΔT_f = K_f × m × i, where K_f is cryoscopic constant, m is molality, i is van't Hoff factor.",
                boilingpoint: "Boiling point elevation: ΔT_b = K_b × m × i, where K_b is ebullioscopic constant.",
                vaporpressure: "Raoult's Law: P_solution = χ_solvent × P°_solvent for ideal solutions."
            },
            
            // ALL REACTION TYPES AND MECHANISMS
            reactionTypes: {
                // BASIC REACTION TYPES
                combustion: "Complete combustion: Hydrocarbon + O₂ → CO₂ + H₂O. Incomplete: Hydrocarbon + O₂ → CO + H₂O or C + H₂O",
                synthesis: "Synthesis (combination): A + B → AB. Elements or compounds combine to form more complex compound.",
                decomposition: "Decomposition: AB → A + B. Complex compound breaks down into simpler substances.",
                singlereplacement: "Single displacement: A + BC → AC + B. More reactive element displaces less reactive one.",
                doublereplacement: "Double displacement: AB + CD → AD + CB. Exchange of ions between two compounds.",
                acidbase: "Acid-base neutralization: Acid + Base → Salt + Water. Proton transfer reactions.",
                
                // ADVANCED REACTION TYPES
                redox: "Oxidation-reduction: Electron transfer reactions. Oxidation = loss of electrons, Reduction = gain of electrons.",
                precipitation: "Formation of insoluble solid from solution: Ag⁺ + Cl⁻ → AgCl(s).",
                complexation: "Formation of coordination compounds: M^n+ + nL → MLn, where M is metal, L is ligand.",
                hydrolysis: "Reaction with water: Salt + H₂O → Acid + Base (for salt hydrolysis).",
                
                // ORGANIC REACTION TYPES
                substitution: "Nucleophilic/Electrophilic substitution: R-X + Nu⁻ → R-Nu + X⁻.",
                elimination: "Removal of atoms/groups: R-CH₂-CH₂-X → R-CH=CH₂ + HX.",
                addition: "Addition across double/triple bonds: R-CH=CH₂ + HX → R-CHX-CH₃.",
                rearrangement: "Intramolecular atom/group migration: Carbocation rearrangements.",
                
                // BIOCHEMICAL REACTIONS
                enzymatic: "Enzyme-catalyzed reactions: E + S ⇌ ES → E + P, where E=enzyme, S=substrate, P=product.",
                fermentation: "Anaerobic glucose breakdown: C₆H₁₂O₆ → 2C₂H₅OH + 2CO₂ (alcoholic fermentation).",
                
                // INDUSTRIAL PROCESSES
                haber: "Ammonia synthesis: N₂ + 3H₂ ⇌ 2NH₃ (high pressure, temperature, catalyst).",
                contact: "Sulfuric acid production: SO₂ + ½O₂ → SO₃, then SO₃ + H₂O → H₂SO₄.",
                ostwald: "Nitric acid production: NH₃ + O₂ → NO → NO₂ → HNO₃.",
                
                // METALLURGICAL REACTIONS
                roasting: "Metal sulfide + O₂ → Metal oxide + SO₂. Preliminary step in metal extraction.",
                smelting: "Metal oxide + C → Metal + CO. Reduction of metal oxides.",
                refining: "Purification of crude metals: Electrolytic refining, zone refining.",
                
                // ENVIRONMENTAL REACTIONS
                photolysis: "Light-induced decomposition: O₃ + hν → O₂ + O (ozone photolysis).",
                catalyticconversion: "Automotive catalysts: CO + NO → CO₂ + ½N₂.",
                
                // NUCLEAR REACTIONS
                fission: "Heavy nucleus splits: ²³⁵U + n → ¹⁴¹Ba + ⁹²Kr + 3n + energy.",
                fusion: "Light nuclei combine: ²H + ³H → ⁴He + n + energy.",
                
                // PHOTOCHEMICAL REACTIONS
                photosynthesis: "6CO₂ + 6H₂O + light → C₆H₁₂O₆ + 6O₂ (chlorophyll catalyst).",
                photography: "AgBr + light → Ag + ½Br₂ (silver halide photography)."
            }
        };

        function performBalancing(reactants, products) {
            const input = `${reactants} → ${products}`.toLowerCase().replace(/\s+/g, '');
            
            // MASSIVE EQUATION DATABASE - COVERS EVERYTHING FROM BASIC TO EXTREMELY ADVANCED
            const equationDatabase = {
                // ===== BASIC COMBUSTION REACTIONS =====
                'h2+o2→h2o': {
                    equation: '2H₂ + O₂ → 2H₂O',
                    explanation: 'Hydrogen combustion - the cleanest fuel reaction. Produces only water as a product, making it ideal for fuel cells and green energy applications.',
                    steps: ['Balance O atoms: need 2H₂O', 'Balance H atoms: need 2H₂', 'Check: 4H, 2O on both sides ✓'],
                    type: 'Combustion', applications: 'Fuel cells, rocket fuel, clean energy'
                },
                'c+o2→co2': {
                    equation: 'C + O₂ → CO₂',
                    explanation: 'Carbon combustion - fundamental reaction in coal burning and carbon cycle.',
                    steps: ['Already balanced', '1C, 2O on both sides ✓'],
                    type: 'Combustion', applications: 'Coal power plants, carbon cycle'
                },
                'ch4+o2→co2+h2o': {
                    equation: 'CH₄ + 2O₂ → CO₂ + 2H₂O',
                    explanation: 'Methane combustion - primary component of natural gas burning.',
                    steps: ['Balance C: 1CO₂', 'Balance H: 2H₂O', 'Balance O: 2O₂', 'Check: 1C, 4H, 4O ✓'],
                    type: 'Combustion', applications: 'Natural gas, heating, cooking'
                },
                'c3h8+o2→co2+h2o': {
                    equation: 'C₃H₈ + 5O₂ → 3CO₂ + 4H₂O',
                    explanation: 'Propane combustion - common in portable fuel applications.',
                    steps: ['Balance C: 3CO₂', 'Balance H: 4H₂O', 'Balance O: 5O₂', 'Check: 3C, 8H, 10O ✓'],
                    type: 'Combustion', applications: 'BBQ grills, camping stoves, forklifts'
                },
                'c2h6+o2→co2+h2o': {
                    equation: '2C₂H₆ + 7O₂ → 4CO₂ + 6H₂O',
                    explanation: 'Ethane combustion - component of natural gas mixtures.',
                    steps: ['Balance C: 2CO₂ per C₂H₆', 'Balance H: 3H₂O per C₂H₆', 'Need whole numbers: multiply by 2', 'Final: 2C₂H₆ + 7O₂ → 4CO₂ + 6H₂O ✓'],
                    type: 'Combustion', applications: 'Natural gas component, petrochemicals'
                },
                'c4h10+o2→co2+h2o': {
                    equation: '2C₄H₁₀ + 13O₂ → 8CO₂ + 10H₂O',
                    explanation: 'Butane combustion - used in lighters and portable stoves.',
                    steps: ['Balance C: 4CO₂ per C₄H₁₀', 'Balance H: 5H₂O per C₄H₁₀', 'Need 6.5O₂, multiply by 2', 'Final: 2C₄H₁₀ + 13O₂ → 8CO₂ + 10H₂O ✓'],
                    type: 'Combustion', applications: 'Lighters, portable stoves, fuel gas'
                },
                'c8h18+o2→co2+h2o': {
                    equation: '2C₈H₁₈ + 25O₂ → 16CO₂ + 18H₂O',
                    explanation: 'Octane combustion - represents gasoline burning in car engines.',
                    steps: ['Balance C: 8CO₂ per C₈H₁₈', 'Balance H: 9H₂O per C₈H₁₈', 'Need 12.5O₂, multiply by 2', 'Final: 2C₈H₁₸ + 25O₂ → 16CO₂ + 18H₂O ✓'],
                    type: 'Combustion', applications: 'Gasoline engines, automotive fuel'
                },
                
                // ===== INCOMPLETE COMBUSTION =====
                'ch4+o2→co+h2o': {
                    equation: '2CH₄ + 3O₂ → 2CO + 4H₂O',
                    explanation: 'Incomplete methane combustion - occurs with insufficient oxygen, producing toxic carbon monoxide.',
                    steps: ['Limited O₂ produces CO instead of CO₂', 'Balance C: 1CO per CH₄', 'Balance H: 2H₂O per CH₄', 'Balance O: need 3O₂ for 2CH₄'],
                    type: 'Incomplete Combustion', applications: 'Faulty gas appliances, carbon monoxide poisoning studies'
                },
                'c+o2→co': {
                    equation: '2C + O₂ → 2CO',
                    explanation: 'Carbon monoxide formation - occurs in limited oxygen conditions.',
                    steps: ['Limited O₂ available', 'Balance: 2C + O₂ → 2CO', 'Check: 2C, 2O on both sides ✓'],
                    type: 'Incomplete Combustion', applications: 'Industrial CO production, blast furnaces'
                },
                
                // ===== SYNTHESIS REACTIONS =====
                'n2+h2→nh3': {
                    equation: 'N₂ + 3H₂ → 2NH₃',
                    explanation: 'Haber process - most important industrial synthesis for fertilizer production.',
                    steps: ['Balance N: need 2NH₃', 'Balance H: need 3H₂', 'Check: 2N, 6H on both sides ✓'],
                    type: 'Synthesis', applications: 'Fertilizer production, explosives, cleaning products'
                },
                'na+cl2→nacl': {
                    equation: '2Na + Cl₂ → 2NaCl',
                    explanation: 'Salt formation - highly exothermic reaction between metal and nonmetal.',
                    steps: ['Balance Cl: need 2NaCl', 'Balance Na: need 2Na', 'Check: 2Na, 2Cl on both sides ✓'],
                    type: 'Synthesis', applications: 'Salt production, food industry'
                },
                'mg+o2→mgo': {
                    equation: '2Mg + O₂ → 2MgO',
                    explanation: 'Magnesium oxide formation - produces brilliant white light.',
                    steps: ['Balance O: need 2MgO', 'Balance Mg: need 2Mg', 'Check: 2Mg, 2O on both sides ✓'],
                    type: 'Synthesis', applications: 'Flares, fireworks, refractory materials'
                },
                'al+o2→al2o3': {
                    equation: '4Al + 3O₂ → 2Al₂O₃',
                    explanation: 'Aluminum oxide formation - creates protective layer on aluminum.',
                    steps: ['Balance Al: need 4Al for 2Al₂O₃', 'Balance O: need 3O₂', 'Check: 4Al, 6O on both sides ✓'],
                    type: 'Synthesis', applications: 'Aluminum protection, ceramics, abrasives'
                },
                'ca+o2→cao': {
                    equation: '2Ca + O₂ → 2CaO',
                    explanation: 'Calcium oxide (lime) formation - important in cement industry.',
                    steps: ['Balance O: need 2CaO', 'Balance Ca: need 2Ca', 'Check: 2Ca, 2O on both sides ✓'],
                    type: 'Synthesis', applications: 'Cement production, steel making'
                },
                
                // ===== DECOMPOSITION REACTIONS =====
                'caco3→cao+co2': {
                    equation: 'CaCO₃ → CaO + CO₂',
                    explanation: 'Limestone decomposition - fundamental reaction in cement and lime production.',
                    steps: ['Thermal decomposition', 'Already balanced', 'Check: 1Ca, 1C, 3O on both sides ✓'],
                    type: 'Decomposition', applications: 'Cement production, lime manufacturing'
                },
                'h2co3→h2o+co2': {
                    equation: 'H₂CO₃ → H₂O + CO₂',
                    explanation: 'Carbonic acid decomposition - occurs in carbonated beverages and blood.',
                    steps: ['Unstable acid decomposes', 'Already balanced', 'Check: 2H, 1C, 3O on both sides ✓'],
                    type: 'Decomposition', applications: 'Carbonated drinks, respiratory system'
                },
                'h2o2→h2o+o2': {
                    equation: '2H₂O₂ → 2H₂O + O₂',
                    explanation: 'Hydrogen peroxide decomposition - catalyzed by enzymes or metals.',
                    steps: ['Balance H₂O: need 2H₂O₂', 'Balance O₂: produces 1O₂', 'Check: 4H, 4O on both sides ✓'],
                    type: 'Decomposition', applications: 'Antiseptic, bleaching, rocket fuel'
                },
                'kclo3→kcl+o2': {
                    equation: '2KClO₃ → 2KCl + 3O₂',
                    explanation: 'Potassium chlorate decomposition - source of oxygen gas.',
                    steps: ['Balance K and Cl: need 2KClO₃ → 2KCl', 'Balance O: produces 3O₂', 'Check: 2K, 2Cl, 6O on both sides ✓'],
                    type: 'Decomposition', applications: 'Oxygen generation, fireworks, matches'
                },
                'nh4no3→n2o+h2o': {
                    equation: 'NH₄NO₃ → N₂O + 2H₂O',
                    explanation: 'Ammonium nitrate decomposition - can be explosive under certain conditions.',
                    steps: ['Thermal decomposition', 'Balance N: produces N₂O', 'Balance H: produces 2H₂O', 'Check: 2N, 4H, 3O on both sides ✓'],
                    type: 'Decomposition', applications: 'Fertilizer, explosives (dangerous!)'
                },
                
                // ===== ACID-BASE REACTIONS =====
                'hcl+naoh→nacl+h2o': {
                    equation: 'HCl + NaOH → NaCl + H₂O',
                    explanation: 'Strong acid-strong base neutralization - produces salt and water.',
                    steps: ['Already balanced', 'H⁺ + OH⁻ → H₂O', 'Check: 1H, 1Cl, 1Na, 1O on both sides ✓'],
                    type: 'Acid-Base', applications: 'Titrations, pH control, salt production'
                },
                'h2so4+naoh→na2so4+h2o': {
                    equation: 'H₂SO₄ + 2NaOH → Na₂SO₄ + 2H₂O',
                    explanation: 'Diprotic acid neutralization - sulfuric acid donates two protons.',
                    steps: ['H₂SO₄ has 2H⁺, need 2NaOH', 'Produces Na₂SO₄ and 2H₂O', 'Check: 2H, 1S, 2Na, 6O on both sides ✓'],
                    type: 'Acid-Base', applications: 'Industrial neutralization, battery acid treatment'
                },
                'hno3+koh→kno3+h2o': {
                    equation: 'HNO₃ + KOH → KNO₃ + H₂O',
                    explanation: 'Nitric acid neutralization - produces potassium nitrate (saltpeter).',
                    steps: ['Already balanced', '1:1 acid:base ratio', 'Check: 1H, 1N, 1K, 4O on both sides ✓'],
                    type: 'Acid-Base', applications: 'Fertilizer production, fireworks'
                },
                'ch3cooh+naoh→ch3coona+h2o': {
                    equation: 'CH₃COOH + NaOH → CH₃COONa + H₂O',
                    explanation: 'Weak acid neutralization - acetic acid (vinegar) with sodium hydroxide.',
                    steps: ['Already balanced', 'Produces sodium acetate', 'Check: 2C, 4H, 1Na, 3O on both sides ✓'],
                    type: 'Acid-Base', applications: 'Food preservation, buffer solutions'
                },
                
                // ===== REDOX REACTIONS =====
                'fe2o3+c→fe+co2': {
                    equation: '2Fe₂O₃ + 3C → 4Fe + 3CO₂',
                    explanation: 'Iron ore reduction - fundamental reaction in steel production.',
                    steps: ['Fe³⁺ reduced to Fe⁰', 'C⁰ oxidized to C⁴⁺', 'Balance Fe: 2Fe₂O₃ → 4Fe', 'Balance C and O: 3C → 3CO₂'],
                    type: 'Redox', applications: 'Steel production, metallurgy'
                },
                'zn+hcl→zncl2+h2': {
                    equation: 'Zn + 2HCl → ZnCl₂ + H₂',
                    explanation: 'Metal-acid reaction - zinc displaces hydrogen from hydrochloric acid.',
                    steps: ['Zn⁰ → Zn²⁺ (oxidation)', 'H⁺ → H₂ (reduction)', 'Need 2HCl for charge balance', 'Check: 1Zn, 2H, 2Cl on both sides ✓'],
                    type: 'Redox', applications: 'Hydrogen gas production, galvanizing'
                },
                'cu+agno3→ag+cu(no3)2': {
                    equation: 'Cu + 2AgNO₃ → 2Ag + Cu(NO₃)₂',
                    explanation: 'Single displacement - copper displaces silver from silver nitrate.',
                    steps: ['Cu⁰ → Cu²⁺ (oxidation)', 'Ag⁺ → Ag⁰ (reduction)', 'Need 2AgNO₃ for electron balance', 'Check: 1Cu, 2Ag, 2N, 6O on both sides ✓'],
                    type: 'Redox', applications: 'Silver plating, electrochemistry demonstrations'
                },
                
                // ===== BIOLOGICAL REACTIONS =====
                'co2+h2o→c6h12o6+o2': {
                    equation: '6CO₂ + 6H₂O → C₆H₁₂O₆ + 6O₂',
                    explanation: 'Photosynthesis - plants convert CO₂ and water to glucose using sunlight.',
                    steps: ['Requires light energy and chlorophyll', 'Balance C: 6CO₂ → C₆H₁₂O₆', 'Balance H: 6H₂O provides 12H', 'Balance O: produces 6O₂'],
                    type: 'Photosynthesis', applications: 'Plant metabolism, oxygen production, carbon fixation'
                },
                'c6h12o6+o2→co2+h2o': {
                    equation: 'C₆H₁₂O₆ + 6O₂ → 6CO₂ + 6H₂O',
                    explanation: 'Cellular respiration - glucose oxidation for energy (ATP) production.',
                    steps: ['Reverse of photosynthesis', 'Releases energy as ATP', 'Balance C: C₆H₁₂O₆ → 6CO₂', 'Balance H and O: need 6O₂, produce 6H₂O'],
                    type: 'Respiration', applications: 'Cellular energy production, metabolism'
                },
                'c6h12o6→c2h5oh+co2': {
                    equation: 'C₆H₁₂O₆ → 2C₂H₅OH + 2CO₂',
                    explanation: 'Alcoholic fermentation - yeast converts glucose to ethanol and CO₂.',
                    steps: ['Anaerobic process', 'Yeast enzymes catalyze reaction', 'Balance C: 6C → 2C₂H₅OH + 2CO₂', 'Check: 6C, 12H, 6O on both sides ✓'],
                    type: 'Fermentation', applications: 'Alcohol production, bread making, biofuel'
                },
                'c6h12o6→c3h6o3': {
                    equation: 'C₆H₁₂O₆ → 2C₃H₆O₃',
                    explanation: 'Lactic acid fermentation - occurs in muscles during intense exercise.',
                    steps: ['Anaerobic glucose breakdown', 'Produces lactic acid', 'Balance: glucose → 2 lactic acid', 'Check: 6C, 12H, 6O on both sides ✓'],
                    type: 'Fermentation', applications: 'Muscle metabolism, yogurt production, food preservation'
                },
                
                // ===== INDUSTRIAL PROCESSES =====
                'so2+o2→so3': {
                    equation: '2SO₂ + O₂ → 2SO₃',
                    explanation: 'Contact process step - sulfur trioxide formation for sulfuric acid production.',
                    steps: ['Requires V₂O₅ catalyst', 'High temperature and pressure', 'Balance: 2SO₂ + O₂ → 2SO₃', 'Check: 2S, 6O on both sides ✓'],
                    type: 'Industrial', applications: 'Sulfuric acid production, chemical industry'
                },
                'so3+h2o→h2so4': {
                    equation: 'SO₃ + H₂O → H₂SO₄',
                    explanation: 'Final step in sulfuric acid production - highly exothermic reaction.',
                    steps: ['Extremely exothermic', 'Must add SO₃ to H₂SO₄, not water', 'Already balanced', 'Check: 1S, 4H, 4O on both sides ✓'],
                    type: 'Industrial', applications: 'Sulfuric acid production, battery acid'
                },
                'nh3+o2→no+h2o': {
                    equation: '4NH₃ + 5O₂ → 4NO + 6H₂O',
                    explanation: 'Ostwald process - ammonia oxidation to produce nitric oxide for nitric acid.',
                    steps: ['Requires Pt catalyst', 'High temperature (900°C)', 'Balance N: 4NH₃ → 4NO', 'Balance H and O: need 5O₂, produce 6H₂O'],
                    type: 'Industrial', applications: 'Nitric acid production, fertilizer industry'
                },
                'no+o2→no2': {
                    equation: '2NO + O₂ → 2NO₂',
                    explanation: 'Nitrogen dioxide formation - second step in nitric acid production.',
                    steps: ['Spontaneous at room temperature', 'Balance: 2NO + O₂ → 2NO₂', 'Check: 2N, 4O on both sides ✓'],
                    type: 'Industrial', applications: 'Nitric acid production, air pollution'
                },
                'no2+h2o→hno3+no': {
                    equation: '3NO₂ + H₂O → 2HNO₃ + NO',
                    explanation: 'Nitric acid formation - disproportionation of nitrogen dioxide.',
                    steps: ['Disproportionation reaction', 'NO₂ both oxidized and reduced', 'Balance: 3NO₂ + H₂O → 2HNO₃ + NO', 'Check: 3N, 7O, 2H on both sides ✓'],
                    type: 'Industrial', applications: 'Nitric acid production, explosives'
                },
                
                // ===== ELECTROCHEMICAL REACTIONS =====
                'nacl→na+cl2': {
                    equation: '2NaCl → 2Na + Cl₂',
                    explanation: 'Electrolysis of molten sodium chloride - produces sodium metal and chlorine gas.',
                    steps: ['Requires electric current', 'Molten NaCl at 800°C', 'Cathode: Na⁺ + e⁻ → Na', 'Anode: 2Cl⁻ → Cl₂ + 2e⁻'],
                    type: 'Electrolysis', applications: 'Sodium production, chlorine production'
                },
                'h2o→h2+o2': {
                    equation: '2H₂O → 2H₂ + O₂',
                    explanation: 'Water electrolysis - splits water into hydrogen and oxygen gases.',
                    steps: ['Requires electric current and electrolyte', 'Cathode: 2H₂O + 2e⁻ → H₂ + 2OH⁻', 'Anode: 2H₂O → O₂ + 4H⁺ + 4e⁻', 'Overall: 2H₂O → 2H₂ + O₂'],
                    type: 'Electrolysis', applications: 'Hydrogen fuel production, oxygen generation'
                },
                'al2o3→al+o2': {
                    equation: '2Al₂O₃ → 4Al + 3O₂',
                    explanation: 'Hall-Héroult process - aluminum production from alumina.',
                    steps: ['Requires molten cryolite (Na₃AlF₆)', 'High temperature electrolysis', 'Cathode: Al³⁺ + 3e⁻ → Al', 'Anode: 2O²⁻ → O₂ + 4e⁻'],
                    type: 'Electrolysis', applications: 'Aluminum production, metal industry'
                },
                
                // ===== ENVIRONMENTAL REACTIONS =====
                'o3→o2+o': {
                    equation: 'O₃ → O₂ + O',
                    explanation: 'Ozone photolysis - UV radiation breaks down ozone in stratosphere.',
                    steps: ['Requires UV radiation', 'Produces oxygen radical', 'Already balanced', 'Check: 3O on both sides ✓'],
                    type: 'Photolysis', applications: 'Ozone layer chemistry, UV protection'
                },
                'cfc+o→clf+o2': {
                    equation: 'CFCl₃ + O → ClF + O₂ + CCl₂',
                    explanation: 'CFC ozone depletion - chlorofluorocarbons destroy ozone layer.',
                    steps: ['CFCs release Cl radicals', 'Cl catalyzes ozone destruction', 'Complex radical chain reaction', 'Simplified representation shown'],
                    type: 'Environmental', applications: 'Ozone depletion studies, environmental chemistry'
                },
                'so2+h2o→h2so3': {
                    equation: 'SO₂ + H₂O → H₂SO₃',
                    explanation: 'Acid rain formation - sulfur dioxide dissolves in water to form sulfurous acid.',
                    steps: ['SO₂ from fossil fuel burning', 'Dissolves in atmospheric water', 'Already balanced', 'Check: 1S, 3O, 2H on both sides ✓'],
                    type: 'Environmental', applications: 'Acid rain studies, air pollution'
                },
                
                // ===== NUCLEAR REACTIONS =====
                'u235+n→ba141+kr92+3n': {
                    equation: '²³⁵U + n → ¹⁴¹Ba + ⁹²Kr + 3n',
                    explanation: 'Nuclear fission - uranium-235 splits into smaller nuclei releasing energy.',
                    steps: ['Mass number: 235 + 1 = 141 + 92 + 3', 'Atomic number: 92 = 56 + 36', 'Releases enormous energy (E=mc²)', 'Chain reaction possible'],
                    type: 'Nuclear Fission', applications: 'Nuclear power, atomic weapons'
                },
                'h2+h3→he4+n': {
                    equation: '²H + ³H → ⁴He + n',
                    explanation: 'Nuclear fusion - deuterium and tritium fuse to form helium and neutron.',
                    steps: ['Mass number: 2 + 3 = 4 + 1', 'Atomic number: 1 + 1 = 2 + 0', 'Requires extreme temperature and pressure', 'Powers the sun and stars'],
                    type: 'Nuclear Fusion', applications: 'Fusion reactors, stellar energy, hydrogen bombs'
                },
                
                // ===== COMPLEX ORGANIC REACTIONS =====
                'c2h4+h2o→c2h5oh': {
                    equation: 'C₂H₄ + H₂O → C₂H₅OH',
                    explanation: 'Ethanol synthesis - hydration of ethylene to produce ethyl alcohol.',
                    steps: ['Requires acid catalyst (H₂SO₄)', 'Addition reaction across double bond', 'Already balanced', 'Check: 2C, 6H, 1O on both sides ✓'],
                    type: 'Organic Addition', applications: 'Ethanol production, alcoholic beverages, fuel additive'
                },
                'c6h6+cl2→c6h5cl+hcl': {
                    equation: 'C₆H₆ + Cl₂ → C₆H₅Cl + HCl',
                    explanation: 'Benzene chlorination - electrophilic aromatic substitution.',
                    steps: ['Requires FeCl₃ catalyst', 'Substitution maintains aromatic ring', 'Already balanced', 'Check: 6C, 6H, 2Cl on both sides ✓'],
                    type: 'Organic Substitution', applications: 'Chlorobenzene production, pharmaceutical intermediates'
                },
                
                // ===== ADVANCED INORGANIC REACTIONS =====
                'pcl5+h2o→h3po4+hcl': {
                    equation: 'PCl₅ + 4H₂O → H₃PO₄ + 5HCl',
                    explanation: 'Phosphorus pentachloride hydrolysis - violent reaction with water.',
                    steps: ['Highly exothermic reaction', 'Complete hydrolysis', 'Balance P: 1H₃PO₄', 'Balance Cl: 5HCl', 'Balance H and O: 4H₂O needed'],
                    type: 'Hydrolysis', applications: 'Phosphoric acid production, chemical synthesis'
                },
                'sf6→sf4+f2': {
                    equation: 'SF₆ → SF₄ + F₂',
                    explanation: 'Sulfur hexafluoride decomposition - occurs at very high temperatures.',
                    steps: ['Requires extreme conditions', 'SF₆ is very stable compound', 'Already balanced', 'Check: 1S, 6F on both sides ✓'],
                    type: 'Decomposition', applications: 'High-voltage equipment, greenhouse gas studies'
                },
                
                // ===== BIOCHEMICAL PATHWAYS =====
                'c6h12o6+6o2→6co2+6h2o+atp': {
                    equation: 'C₆H₁₂O₆ + 6O₂ → 6CO₂ + 6H₂O + 38ATP',
                    explanation: 'Complete glucose oxidation - cellular respiration producing ATP energy.',
                    steps: ['Glycolysis: glucose → pyruvate', 'Krebs cycle: pyruvate → CO₂', 'Electron transport: O₂ → H₂O', 'Net yield: 38 ATP molecules'],
                    type: 'Biochemical', applications: 'Cellular energy production, metabolism studies'
                },
                'c12h22o11+h2o→c6h12o6': {
                    equation: 'C₁₂H₂₂O₁₁ + H₂O → 2C₆H₁₂O₆',
                    explanation: 'Sucrose hydrolysis - table sugar breaks down into glucose and fructose.',
                    steps: ['Enzyme-catalyzed reaction', 'Disaccharide → monosaccharides', 'Balance: 1 sucrose + water → 2 hexoses', 'Check: 12C, 24H, 12O on both sides ✓'],
                    type: 'Biochemical', applications: 'Digestion, food processing, diabetes studies'
                }
            };
            
            // Normalize input for matching
            const normalizedInput = input.replace(/\s+/g, '').toLowerCase();
            
            // Try exact matches first
            if (equationDatabase[normalizedInput]) {
                return equationDatabase[normalizedInput];
            }
            
            // Try partial matches and variations
            for (const [key, value] of Object.entries(equationDatabase)) {
                // Check if input contains the key pattern
                if (normalizedInput.includes(key.replace('→', '')) || 
                    key.includes(normalizedInput.replace('→', ''))) {
                    return value;
                }
                
                // Check reverse order of reactants
                const parts = key.split('→');
                if (parts.length === 2) {
                    const reactants = parts[0].split('+').reverse().join('+');
                    const reversedKey = reactants + '→' + parts[1];
                    if (normalizedInput.includes(reversedKey.replace('→', ''))) {
                        return value;
                    }
                }
            }
            
            // If no exact match, provide intelligent analysis
            return analyzeUnknownEquation(reactants, products);
        }
        
        function analyzeUnknownEquation(reactants, products) {
            const reactantList = reactants.toLowerCase().split('+').map(r => r.trim());
            const productList = products.toLowerCase().split('+').map(p => p.trim());
            
            // Determine reaction type
            let reactionType = 'Unknown';
            let explanation = '';
            let steps = [];
            
            // Check for combustion patterns
            if (reactantList.some(r => r.includes('o2')) && 
                productList.some(p => p.includes('co2') || p.includes('h2o'))) {
                reactionType = 'Combustion';
                explanation = 'This appears to be a combustion reaction where an organic compound reacts with oxygen to produce carbon dioxide and water.';
                steps = [
                    'Identify this as a combustion reaction (organic compound + O₂)',
                    'Balance carbon atoms first by adjusting CO₂ coefficient',
                    'Balance hydrogen atoms by adjusting H₂O coefficient', 
                    'Balance oxygen atoms last by adjusting O₂ coefficient',
                    'Check that all atoms are balanced on both sides'
                ];
            }
            // Check for synthesis patterns
            else if (reactantList.length > 1 && productList.length === 1) {
                reactionType = 'Synthesis';
                explanation = 'This appears to be a synthesis reaction where two or more reactants combine to form a single product.';
                steps = [
                    'Identify this as a synthesis reaction (A + B → AB)',
                    'Count atoms of each element on both sides',
                    'Start balancing with the most complex molecule',
                    'Adjust coefficients to balance all elements',
                    'Verify that the law of conservation of mass is satisfied'
                ];
            }
            // Check for decomposition patterns
            else if (reactantList.length === 1 && productList.length > 1) {
                reactionType = 'Decomposition';
                explanation = 'This appears to be a decomposition reaction where a single compound breaks down into two or more products.';
                steps = [
                    'Identify this as a decomposition reaction (AB → A + B)',
                    'Count atoms in the reactant compound',
                    'Ensure all atoms appear in the products',
                    'Balance coefficients to conserve all elements',
                    'Check that no atoms are lost or gained'
                ];
            }
            // Check for replacement patterns
            else if (reactantList.length === 2 && productList.length === 2) {
                reactionType = 'Replacement';
                explanation = 'This appears to be a replacement reaction where elements or compounds exchange partners.';
                steps = [
                    'Identify this as a replacement reaction',
                    'Determine which elements are being exchanged',
                    'Balance the exchanging elements first',
                    'Balance remaining elements',
                    'Verify conservation of mass'
                ];
            }
            
            return {
                equation: `${reactants} → ${products}`,
                explanation: explanation || 'I can help you balance this equation using systematic methods.',
                steps: steps.length > 0 ? steps : [
                    'Count atoms of each element on both sides',
                    'Identify the most complex molecule to start with',
                    'Balance metals first, then non-metals',
                    'Balance hydrogen and oxygen last (if present)',
                    'Use whole number coefficients only',
                    'Verify that all atoms are balanced'
                ],
                type: reactionType,
                applications: 'Chemical equations are fundamental to understanding reaction stoichiometry and predicting product quantities.'
            };
        }

        // Quiz selector functions
        function selectDifficulty(difficulty, element, selectorId) {
            document.querySelectorAll(`[onclick*="selectDifficulty"][onclick*="${selectorId}"]`).forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById(`selectedDifficulty${selectorId}`).value = difficulty;
            checkQuizSettings(selectorId);
        }

        function selectQuestionCount(count, element, selectorId) {
            document.querySelectorAll(`[onclick*="selectQuestionCount"][onclick*="${selectorId}"]`).forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById(`selectedCount${selectorId}`).value = count;
            checkQuizSettings(selectorId);
        }

        function checkQuizSettings(selectorId) {
            const difficulty = document.getElementById(`selectedDifficulty${selectorId}`).value;
            const count = document.getElementById(`selectedCount${selectorId}`).value;
            const startBtn = document.getElementById(`startQuizBtn${selectorId}`);
            startBtn.disabled = !difficulty || !count;
        }

        function startCustomQuiz(selectorId) {
            const difficulty = document.getElementById(`selectedDifficulty${selectorId}`).value;
            const count = parseInt(document.getElementById(`selectedCount${selectorId}`).value);
            
            const quizHTML = generateQuiz(difficulty, count);
            addMessage(quizHTML, 'bot', 'quiz');
        }

        function generateQuiz(difficulty = 'normal', questionCount = 5) {
            const quizData = {
                easy: [
                    {
                        question: "What is Avogadro's number?",
                        options: ["6.022 × 10²³", "6.022 × 10²²", "3.011 × 10²³", "1.204 × 10²⁴"],
                        correct: 0,
                        explanation: "Avogadro's number is exactly 6.022 × 10²³ particles per mole!"
                    },
                    {
                        question: "How many atoms are in 1 mole of carbon?",
                        options: ["6.022 × 10²³", "12", "6", "24"],
                        correct: 0,
                        explanation: "1 mole of any element contains Avogadro's number of atoms!"
                    },
                    {
                        question: "What is the molar mass of water (H₂O)? (H=1, O=16)",
                        options: ["16 g/mol", "17 g/mol", "18 g/mol", "19 g/mol"],
                        correct: 2,
                        explanation: "H₂O = (2×1) + (1×16) = 2 + 16 = 18 g/mol"
                    },
                    {
                        question: "Which of these is a balanced equation?",
                        options: ["H₂ + O₂ → H₂O", "2H₂ + O₂ → 2H₂O", "H₂ + 2O₂ → H₂O", "3H₂ + O₂ → 3H₂O"],
                        correct: 1,
                        explanation: "2H₂ + O₂ → 2H₂O has equal atoms on both sides: 4H and 2O"
                    },
                    {
                        question: "What does the coefficient 2 in 2NaCl represent?",
                        options: ["2 atoms of Na", "2 molecules of NaCl", "2 grams of NaCl", "2 moles of NaCl"],
                        correct: 3,
                        explanation: "Coefficients in chemical equations represent the number of moles!"
                    }
                ],
                normal: [
                    {
                        question: "How many moles are in 36g of H₂O? (H=1, O=16)",
                        options: ["1 mole", "2 moles", "3 moles", "4 moles"],
                        correct: 1,
                        explanation: "moles = mass/molar mass = 36g ÷ 18g/mol = 2 moles"
                    },
                    {
                        question: "In 2H₂ + O₂ → 2H₂O, what is the mole ratio of H₂ to H₂O?",
                        options: ["1:1", "2:1", "1:2", "2:2"],
                        correct: 0,
                        explanation: "From coefficients: 2H₂ produces 2H₂O, so ratio is 2:2 = 1:1"
                    },
                    {
                        question: "If 3 moles of O₂ react in C₃H₈ + 5O₂ → 3CO₂ + 4H₂O, how many moles of CO₂ form?",
                        options: ["1.8 mol", "2.4 mol", "3.0 mol", "5.0 mol"],
                        correct: 0,
                        explanation: "Ratio O₂:CO₂ = 5:3, so 3 mol O₂ × (3/5) = 1.8 mol CO₂"
                    },
                    {
                        question: "What mass of CO₂ is produced from 12g of C? (C=12, O=16)",
                        options: ["22g", "44g", "66g", "88g"],
                        correct: 1,
                        explanation: "C + O₂ → CO₂: 1 mol C (12g) produces 1 mol CO₂ (44g)"
                    },
                    {
                        question: "In a reaction, if theoretical yield is 50g and actual yield is 40g, what's the percent yield?",
                        options: ["75%", "80%", "85%", "90%"],
                        correct: 1,
                        explanation: "% yield = (actual/theoretical) × 100% = (40/50) × 100% = 80%"
                    }
                ],
                hard: [
                    {
                        question: "Calculate moles of CO₂ from 25g C in C + O₂ → CO₂ (C=12)",
                        options: ["2.08 mol", "1.04 mol", "3.12 mol", "0.52 mol"],
                        correct: 0,
                        explanation: "25g C ÷ 12g/mol = 2.08 mol C, which produces 2.08 mol CO₂ (1:1 ratio)"
                    },
                    {
                        question: "In 4NH₃ + 5O₂ → 4NO + 6H₂O, if NH₃ is limiting with 2 mol available, how much H₂O forms?",
                        options: ["2 mol", "3 mol", "4 mol", "6 mol"],
                        correct: 1,
                        explanation: "Ratio NH₃:H₂O = 4:6 = 2:3, so 2 mol NH₃ × (6/4) = 3 mol H₂O"
                    },
                    {
                        question: "What's the empirical formula of a compound with 40% C, 6.7% H, 53.3% O? (C=12, H=1, O=16)",
                        options: ["CHO", "CH₂O", "C₂H₄O₂", "C₃H₆O₃"],
                        correct: 1,
                        explanation: "40/12 : 6.7/1 : 53.3/16 = 3.33 : 6.7 : 3.33 = 1:2:1 → CH₂O"
                    },
                    {
                        question: "At STP, what volume does 3.5 mol of any gas occupy?",
                        options: ["22.4 L", "44.8 L", "67.2 L", "78.4 L"],
                        correct: 3,
                        explanation: "At STP: 1 mol gas = 22.4 L, so 3.5 mol × 22.4 L/mol = 78.4 L"
                    },
                    {
                        question: "In electrolysis of water, how many moles of electrons are needed to produce 1 mol H₂?",
                        options: ["1 mol e⁻", "2 mol e⁻", "3 mol e⁻", "4 mol e⁻"],
                        correct: 1,
                        explanation: "2H⁺ + 2e⁻ → H₂, so 1 mol H₂ requires 2 mol electrons"
                    }
                ],
                extreme: [
                    {
                        question: "Calculate ΔH for CH₄ + 2O₂ → CO₂ + 2H₂O given: C-H = 413 kJ/mol, O=O = 498 kJ/mol, C=O = 799 kJ/mol, O-H = 464 kJ/mol",
                        options: ["-890 kJ/mol", "-802 kJ/mol", "-1220 kJ/mol", "-658 kJ/mol"],
                        correct: 1,
                        explanation: "ΔH = bonds broken - bonds formed = [4(413) + 2(498)] - [2(799) + 4(464)] = 2648 - 3450 = -802 kJ/mol"
                    },
                    {
                        question: "For the equilibrium N₂ + 3H₂ ⇌ 2NH₃, if Kc = 0.5 at 500°C and [N₂] = 2M, [H₂] = 1M, what is [NH₃]?",
                        options: ["0.5 M", "1.0 M", "1.4 M", "2.0 M"],
                        correct: 1,
                        explanation: "Kc = [NH₃]²/([N₂][H₂]³) = 0.5 = [NH₃]²/(2×1³), so [NH₃]² = 1, [NH₃] = 1.0 M"
                    },
                    {
                        question: "What's the pH of 0.1 M CH₃COOH solution? (Ka = 1.8 × 10⁻⁵)",
                        options: ["1.0", "2.9", "4.7", "7.0"],
                        correct: 1,
                        explanation: "For weak acid: [H⁺] = √(Ka × C) = √(1.8×10⁻⁵ × 0.1) = 1.34×10⁻³, pH = -log(1.34×10⁻³) = 2.9"
                    },
                    {
                        question: "In the reaction 2A + B → 3C, if rate = k[A]²[B] and [A] doubles while [B] triples, how does the rate change?",
                        options: ["6× faster", "9× faster", "12× faster", "18× faster"],
                        correct: 2,
                        explanation: "New rate = k(2[A])²(3[B]) = k×4[A]²×3[B] = 12×k[A]²[B] = 12× original rate"
                    },
                    {
                        question: "Calculate the cell potential for Zn|Zn²⁺||Cu²⁺|Cu given E°(Zn²⁺/Zn) = -0.76V, E°(Cu²⁺/Cu) = +0.34V",
                        options: ["+0.42 V", "+1.10 V", "-0.42 V", "-1.10 V"],
                        correct: 1,
                        explanation: "E°cell = E°cathode - E°anode = 0.34V - (-0.76V) = +1.10V"
                    }
                ]
            };
            
            const questions = quizData[difficulty] || quizData.normal;
            const selectedQuestions = questions.slice(0, Math.min(questionCount, questions.length));
            const quizId = Date.now();
            
            // Store quiz data globally for access
            window.currentQuiz = {
                id: quizId,
                questions: selectedQuestions,
                currentQuestion: 0,
                score: 0,
                answered: []
            };
            
            let quizHTML = `
                <div class="quiz-container" id="quiz-${quizId}">
                    <div class="quiz-header">
                        <h3>🎯 ${difficulty.toUpperCase()} Quiz</h3>
                        <p>Question ${window.currentQuiz.currentQuestion + 1} of ${selectedQuestions.length}</p>
                        <div style="background: #e9ecef; border-radius: 10px; height: 8px; margin: 10px 0;">
                            <div style="background: #007bff; height: 100%; border-radius: 10px; width: ${((window.currentQuiz.currentQuestion + 1) / selectedQuestions.length) * 100}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div class="quiz-content" id="quiz-content-${quizId}">
            `;
            
            // Show only the first question initially
            const firstQuestion = selectedQuestions[0];
            quizHTML += `
                <div class="quiz-question">${firstQuestion.question}</div>
                <div class="quiz-options" id="quiz-options-${quizId}">
            `;
            
            firstQuestion.options.forEach((option, index) => {
                quizHTML += `
                    <button class="quiz-option" onclick="selectQuizOption(${quizId}, ${index}, ${firstQuestion.correct}, '${firstQuestion.explanation}')">
                        ${String.fromCharCode(65 + index)}. ${option}
                    </button>
                `;
            });
            
            quizHTML += `
                    </div>
                </div>
            </div>`;
            
            return quizHTML;
        }

        function selectQuizOption(quizId, selected, correct, explanation) {
            if (!window.currentQuiz || window.currentQuiz.id !== quizId) {
                console.error('Quiz data not found');
                return;
            }
            
            const quizContainer = document.getElementById(`quiz-${quizId}`);
            if (!quizContainer) {
                console.error('Quiz container not found');
                return;
            }
            
            const options = quizContainer.querySelectorAll('.quiz-option');
            
            // Disable all options and show correct/incorrect
            options.forEach((option, index) => {
                option.onclick = null;
                option.disabled = true;
                if (index === correct) {
                    option.classList.add('correct');
                } else if (index === selected && index !== correct) {
                    option.classList.add('incorrect');
                }
            });
            
            // Update score
            if (selected === correct) {
                window.currentQuiz.score++;
            }
            
            window.currentQuiz.answered.push({
                question: window.currentQuiz.currentQuestion,
                selected: selected,
                correct: correct,
                isCorrect: selected === correct
            });
            
            // Show explanation and next question after delay
            setTimeout(() => {
                const isCorrect = selected === correct;
                const feedback = isCorrect ? 
                    `✅ Correct, ${userProfile.nickname}! 🎉` : 
                    `❌ Not quite right, ${userProfile.nickname}.`;
                
                // Show explanation
                const explanationDiv = document.createElement('div');
                explanationDiv.style.cssText = `
                    margin-top: 15px;
                    padding: 15px;
                    background: ${isCorrect ? '#d4edda' : '#f8d7da'};
                    border: 1px solid ${isCorrect ? '#c3e6cb' : '#f5c6cb'};
                    border-radius: 8px;
                    color: ${isCorrect ? '#155724' : '#721c24'};
                `;
                explanationDiv.innerHTML = `
                    <strong>${feedback}</strong><br>
                    <em>${explanation}</em>
                `;
                
                const quizContent = document.getElementById(`quiz-content-${quizId}`);
                quizContent.appendChild(explanationDiv);
                
                // Move to next question or show results
                setTimeout(() => {
                    window.currentQuiz.currentQuestion++;
                    
                    if (window.currentQuiz.currentQuestion < window.currentQuiz.questions.length) {
                        showNextQuestion(quizId);
                    } else {
                        showQuizResults(quizId);
                    }
                }, 2000);
                
            }, 500);
        }
        
        function showNextQuestion(quizId) {
            const currentQ = window.currentQuiz.currentQuestion;
            const question = window.currentQuiz.questions[currentQ];
            const totalQuestions = window.currentQuiz.questions.length;
            
            // Update progress bar
            const progressBar = document.querySelector(`#quiz-${quizId} .quiz-header div div`);
            if (progressBar) {
                progressBar.style.width = `${((currentQ + 1) / totalQuestions) * 100}%`;
            }
            
            // Update question counter
            const questionCounter = document.querySelector(`#quiz-${quizId} .quiz-header p`);
            if (questionCounter) {
                questionCounter.textContent = `Question ${currentQ + 1} of ${totalQuestions}`;
            }
            
            // Update question content
            const quizContent = document.getElementById(`quiz-content-${quizId}`);
            quizContent.innerHTML = `
                <div class="quiz-question">${question.question}</div>
                <div class="quiz-options" id="quiz-options-${quizId}">
            `;
            
            let optionsHTML = '';
            question.options.forEach((option, index) => {
                optionsHTML += `
                    <button class="quiz-option" onclick="selectQuizOption(${quizId}, ${index}, ${question.correct}, '${question.explanation.replace(/'/g, "\\'")}')">
                        ${String.fromCharCode(65 + index)}. ${option}
                    </button>
                `;
            });
            
            quizContent.innerHTML += optionsHTML + '</div>';
        }
        
        function showQuizResults(quizId) {
            const score = window.currentQuiz.score;
            const total = window.currentQuiz.questions.length;
            const percentage = Math.round((score / total) * 100);
            
            let performance = '';
            let emoji = '';
            
            if (percentage >= 90) {
                performance = 'Outstanding! 🌟';
                emoji = '🏆';
            } else if (percentage >= 80) {
                performance = 'Excellent work! 👏';
                emoji = '🎉';
            } else if (percentage >= 70) {
                performance = 'Good job! 👍';
                emoji = '😊';
            } else if (percentage >= 60) {
                performance = 'Not bad, keep practicing! 📚';
                emoji = '💪';
            } else {
                performance = 'Keep studying, you can do it! 🔬';
                emoji = '📖';
            }
            
            const quizContent = document.getElementById(`quiz-content-${quizId}`);
            quizContent.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">${emoji}</div>
                    <h2 style="color: #007bff; margin: 0 0 10px 0;">Quiz Complete!</h2>
                    <div style="font-size: 2rem; font-weight: bold; color: #28a745; margin: 20px 0;">
                        ${score}/${total} (${percentage}%)
                    </div>
                    <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                        ${performance}
                    </p>
                    <button onclick="startNewQuiz()" style="
                        background: #007bff;
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        margin: 10px;
                    ">🎯 Take Another Quiz</button>
                    <button onclick="reviewAnswers(${quizId})" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 15px 30px;
                        border-radius: 25px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        margin: 10px;
                    ">📋 Review Answers</button>
                </div>
            `;
            
            // Update progress bar to 100%
            const progressBar = document.querySelector(`#quiz-${quizId} .quiz-header div div`);
            if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.style.background = '#28a745';
            }
            
            // Update header
            const questionCounter = document.querySelector(`#quiz-${quizId} .quiz-header p`);
            if (questionCounter) {
                questionCounter.textContent = `Completed! Final Score: ${score}/${total}`;
            }
        }
        
        function startNewQuiz() {
            sendQuickMessage('Start quiz');
        }
        
        function reviewAnswers(quizId) {
            if (!window.currentQuiz) return;
            
            let reviewHTML = `📋 **Quiz Review:**\n\n`;
            
            window.currentQuiz.answered.forEach((answer, index) => {
                const question = window.currentQuiz.questions[answer.question];
                const status = answer.isCorrect ? '✅' : '❌';
                const selectedLetter = String.fromCharCode(65 + answer.selected);
                const correctLetter = String.fromCharCode(65 + answer.correct);
                
                reviewHTML += `**${index + 1}. ${question.question}**\n`;
                reviewHTML += `Your answer: ${selectedLetter} ${status}\n`;
                if (!answer.isCorrect) {
                    reviewHTML += `Correct answer: ${correctLetter}\n`;
                }
                reviewHTML += `${question.explanation}\n\n`;
            });
            
            addMessage(reviewHTML, 'bot');
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // Enable start button when both fields are filled
        document.getElementById('nickname').addEventListener('input', function() {
            const nickname = this.value.trim();
            const age = document.getElementById('selectedAge').value;
            document.getElementById('startBtn').disabled = !nickname || !age;
        });

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9967bb62671dbc55',t:'MTc2MTc5Mzk1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
