<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StoichBot - Chemistry Learning Platform</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-x: hidden;
        }

        html {
            height: 100%;
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 0;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #007bff;
        }

        .chat-toggle-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .chat-toggle-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        /* Hero Section */
        .hero {
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            padding: 100px 20px 50px;
        }

        .hero-content {
            max-width: 800px;
        }

        .hero h1 {
            font-size: 3.5rem;
            margin: 0 0 20px 0;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .hero p {
            font-size: 1.3rem;
            margin: 0 0 40px 0;
            opacity: 0.9;
            line-height: 1.6;
        }

        .hero-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,123,255,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
        }

        .btn-secondary:hover {
            background: white;
            color: #007bff;
            transform: translateY(-3px);
        }

        /* Features Section */
        .features {
            padding: 80px 20px;
            background: white;
        }

        .features-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .features h2 {
            text-align: center;
            font-size: 2.5rem;
            margin: 0 0 60px 0;
            color: #333;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 40px;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 40px 30px;
            border-radius: 20px;
            text-align: center;
            transition: transform 0.3s;
            border: 1px solid #e9ecef;
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .feature-card h3 {
            font-size: 1.5rem;
            margin: 0 0 15px 0;
            color: #333;
        }

        .feature-card p {
            color: #666;
            line-height: 1.6;
            margin: 0;
        }

        /* Chat Interface */
        .chat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 90%;
            max-height: 700px;
            background: white;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 20px;
        }

        .close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-chat:hover {
            background: rgba(255,255,255,0.2);
        }

        .welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .welcome-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .welcome-card h2 {
            color: #007bff;
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .welcome-card p {
            color: #666;
            margin: 0 0 30px 0;
            line-height: 1.6;
        }

        .welcome-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .age-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .age-option {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 14px;
        }

        .age-option:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .age-option.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .start-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .start-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .start-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 300px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
        }

        .message.user .message-content {
            background: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .quick-actions {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .quick-actions h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .action-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #495057;
        }

        .action-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 14px;
            outline: none;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            font-family: inherit;
        }

        .input-field:focus {
            border-color: #007bff;
        }

        .send-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
        }

        .send-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 10px 16px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 70%;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Quiz Styles */
        .quiz-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .quiz-question {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quiz-option {
            background: white;
            border: 2px solid #dee2e6;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quiz-option:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .quiz-option.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .quiz-option.correct {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }

        .quiz-option.incorrect {
            border-color: #dc3545;
            background: #dc3545;
            color: white;
        }

        /* Balance Calculator Styles */
        .balance-calculator-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
        }

        .calculator-header h3 {
            margin: 0 0 10px 0;
            color: #007bff;
            font-size: 20px;
        }

        .calculator-header p {
            margin: 0 0 20px 0;
            color: #666;
        }

        .equation-input-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .equation-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .equation-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .arrow-symbol {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 0 10px;
        }

        .calculator-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .balance-btn, .clear-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .balance-btn {
            background: #28a745;
            color: white;
        }

        .balance-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .clear-btn {
            background: #6c757d;
            color: white;
        }

        .clear-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .result-section {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .balanced-result h4 {
            margin: 0 0 15px 0;
            color: #28a745;
        }

        .equation-display {
            font-size: 18px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #28a745;
        }

        .balance-explanation {
            margin-top: 20px;
        }

        .balance-explanation h4 {
            margin: 0 0 10px 0;
            color: #007bff;
        }

        .balance-explanation p {
            margin: 0 0 15px 0;
            line-height: 1.6;
        }

        .steps h5 {
            margin: 15px 0 10px 0;
            color: #333;
        }

        .steps ol {
            margin: 0;
            padding-left: 20px;
        }

        .steps li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .calculator-help {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 10px;
        }

        .calculator-help h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }

        .calculator-help ul {
            margin: 0;
            padding-left: 20px;
        }

        .calculator-help li {
            margin-bottom: 5px;
            color: #6c757d;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            text-align: center;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .hero p {
                font-size: 1.1rem;
            }
            
            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .nav-links {
                display: none;
            }
            
            .chat-container {
                width: 95%;
                height: 95%;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .equation-input-section {
                flex-direction: column;
            }
            
            .input-group {
                min-width: 100%;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Navigation -->
  <nav class="navbar">
   <div class="nav-container"><a href="#" class="logo" id="site-title">StoichBot</a>
    <ul class="nav-links">
     <li><a href="#home">Home</a></li>
     <li><a href="#features">Features</a></li>
     <li><a href="#about">About</a></li>
    </ul><button class="chat-toggle-btn" onclick="openChat()">üí¨ Start Learning</button>
   </div>
  </nav><!-- Hero Section -->
  <section class="hero" id="home">
   <div class="hero-content">
    <h1 id="hero-title">Master Chemistry with StoichBot</h1>
    <p id="hero-subtitle">Your AI-powered chemistry tutor specialized in stoichiometry. Learn, practice, and excel with personalized guidance!</p>
    <div class="hero-buttons"><button class="btn btn-primary" onclick="openChat()">üöÄ Start Learning Now</button> <a href="#features" class="btn btn-secondary">üìö Explore Features</a>
    </div>
   </div>
  </section><!-- Features Section -->
  <section class="features" id="features">
   <div class="features-container">
    <h2>Why Choose StoichBot?</h2>
    <div class="features-grid">
     <div class="feature-card">
      <div class="feature-icon">
       ü§ñ
      </div>
      <h3>AI-Powered Tutoring</h3>
      <p>Get personalized explanations adapted to your age and learning level. Our AI understands your needs and adjusts accordingly.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       ‚öñÔ∏è
      </div>
      <h3>Equation Balancer</h3>
      <p>Interactive calculator that balances chemical equations step-by-step with detailed explanations of the process.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       üéØ
      </div>
      <h3>Practice Quizzes</h3>
      <p>Test your knowledge with customizable quizzes. Choose difficulty levels and track your progress over time.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       üìä
      </div>
      <h3>Problem Solving</h3>
      <p>Step-by-step solutions for stoichiometry problems with clear explanations and calculation methods.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       üî¨
      </div>
      <h3>Concept Mastery</h3>
      <p>Deep dive into mole concepts, limiting reactants, percent yield, and all essential stoichiometry topics.</p>
     </div>
     <div class="feature-card">
      <div class="feature-icon">
       üíæ
      </div>
      <h3>Progress Tracking</h3>
      <p>Your conversations and progress are saved automatically. Pick up where you left off anytime!</p>
     </div>
    </div>
   </div>
  </section><!-- Chat Overlay -->
  <div class="chat-overlay" id="chatOverlay">
   <div class="chat-container">
    <div class="welcome-screen" id="welcomeScreen">
     <div class="welcome-card">
      <h2>üëã Welcome to StoichBot!</h2>
      <p>I'm your personal chemistry assistant, specialized in stoichiometry. Let's get to know each other first!</p>
      <form class="welcome-form" onsubmit="startChat(event)">
       <div class="form-group"><label for="nickname">What should I call you?</label> <input type="text" id="nickname" class="form-input" placeholder="Enter your nickname" required>
       </div>
       <div class="form-group"><label>What's your age group?</label>
        <div class="age-selector">
         <div class="age-option" onclick="selectAge('13-15', this)">
          13-15 years
         </div>
         <div class="age-option" onclick="selectAge('16-18', this)">
          16-18 years
         </div>
         <div class="age-option" onclick="selectAge('19-21', this)">
          19-21 years
         </div>
         <div class="age-option" onclick="selectAge('22+', this)">
          22+ years
         </div>
        </div><input type="hidden" id="selectedAge" required>
       </div><button type="submit" class="start-btn" id="startBtn" disabled> üöÄ Start Learning Chemistry! </button>
      </form>
     </div>
    </div>
    <div class="chat-header">
     <h3 id="chatbot-name">StoichBot - Your Chemistry Assistant</h3><button class="close-chat" onclick="closeChat()">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages">
     <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots">
       <div class="typing-dot"></div>
       <div class="typing-dot"></div>
       <div class="typing-dot"></div>
      </div>
     </div>
    </div>
    <div class="quick-actions">
     <h4>Quick Actions</h4>
     <div class="action-buttons"><button class="action-btn" onclick="sendQuickMessage('What is stoichiometry?')">üß™ Stoichiometry Basics</button> <button class="action-btn" onclick="sendQuickMessage('Help me balance equations')">‚öñÔ∏è Balance Equations</button> <button class="action-btn" onclick="sendQuickMessage('Solve stoichiometry problem')">üßÆ Problem Solving</button> <button class="action-btn" onclick="sendQuickMessage('Start quiz')">üéØ Take Quiz</button> <button class="action-btn" onclick="sendQuickMessage('Explain limiting reactants')">üî¨ Limiting Reactants</button>
     </div>
    </div>
    <div class="chat-input">
     <div class="input-container"><textarea id="messageInput" class="input-field" placeholder="Ask me anything about stoichiometry..." rows="1" onkeypress="handleKeyPress(event)" oninput="adjustTextareaHeight(this)"></textarea> <button class="send-btn" id="sendBtn" onclick="sendMessage()"> ‚û§ </button>
     </div>
    </div>
   </div>
  </div>
  <script>
        let currentLanguage = 'en';
        let chatHistory = [];
        let isLoading = false;
        let userProfile = {
            nickname: '',
            age: '',
            isSetup: false
        };
        
        const defaultConfig = {
            site_title: 'StoichBot',
            hero_title: 'Master Chemistry with StoichBot',
            hero_subtitle: 'Your AI-powered chemistry tutor specialized in stoichiometry. Learn, practice, and excel with personalized guidance!',
            chatbot_name: 'StoichBot',
            welcome_message: 'Hello! I\'m your chemistry assistant specialized in stoichiometry. How can I help you today?',
            primary_color: '#007bff',
            surface_color: '#ffffff'
        };

        // Stoichiometry-related keywords for scope checking
        const stoichiometryKeywords = [
            'mole', 'mol', 'stoichiometry', 'stoichiometric', 'avogadro', 'balance', 'equation', 'chemical',
            'reaction', 'reactant', 'product', 'limiting', 'excess', 'yield', 'percent', 'theoretical',
            'actual', 'mass', 'molecular', 'atomic', 'formula', 'empirical', 'compound', 'element',
            'coefficient', 'ratio', 'proportion', 'calculate', 'conversion', 'gram', 'kilogram',
            'molecule', 'atom', 'ion', 'chemistry', 'periodic', 'table', 'concentration', 'molarity',
            'solution', 'solute', 'solvent', 'gas', 'stp', 'volume', 'pressure', 'temperature'
        ];

        const dataHandler = {
            onDataChanged(data) {
                chatHistory = data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                renderChatHistory();
            }
        };

        const elementHandler = {
            defaultConfig: defaultConfig,
            onConfigChange: async (config) => {
                document.getElementById('site-title').textContent = config.site_title || defaultConfig.site_title;
                document.getElementById('hero-title').textContent = config.hero_title || defaultConfig.hero_title;
                document.getElementById('hero-subtitle').textContent = config.hero_subtitle || defaultConfig.hero_subtitle;
                document.getElementById('chatbot-name').textContent = config.chatbot_name || defaultConfig.chatbot_name;
                
                const primaryColor = config.primary_color || defaultConfig.primary_color;
                const surfaceColor = config.surface_color || defaultConfig.surface_color;
                
                document.documentElement.style.setProperty('--primary-color', primaryColor);
                document.documentElement.style.setProperty('--surface-color', surfaceColor);
                
                const buttons = document.querySelectorAll('.btn-primary, .chat-toggle-btn, .send-btn, .start-btn');
                buttons.forEach(btn => {
                    btn.style.backgroundColor = primaryColor;
                });
                
                const userMessages = document.querySelectorAll('.message.user .message-content');
                userMessages.forEach(msg => {
                    msg.style.backgroundColor = primaryColor;
                });
            },
            mapToCapabilities: (config) => ({
                recolorables: [
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            config.primary_color = value;
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    },
                    {
                        get: () => config.surface_color || defaultConfig.surface_color,
                        set: (value) => {
                            config.surface_color = value;
                            window.elementSdk.setConfig({ surface_color: value });
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
                ['site_title', config.site_title || defaultConfig.site_title],
                ['hero_title', config.hero_title || defaultConfig.hero_title],
                ['hero_subtitle', config.hero_subtitle || defaultConfig.hero_subtitle],
                ['chatbot_name', config.chatbot_name || defaultConfig.chatbot_name],
                ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
            ])
        };

        async function initializeApp() {
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error('Failed to initialize data SDK');
                }
            }

            if (window.elementSdk) {
                await window.elementSdk.init(elementHandler);
            }
        }

        function openChat() {
            document.getElementById('chatOverlay').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeChat() {
            document.getElementById('chatOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function selectAge(age, element) {
            document.querySelectorAll('.age-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('selectedAge').value = age;
            
            const nickname = document.getElementById('nickname').value.trim();
            document.getElementById('startBtn').disabled = !nickname;
        }

        function startChat(event) {
            event.preventDefault();
            
            const nickname = document.getElementById('nickname').value.trim();
            const age = document.getElementById('selectedAge').value;
            
            if (!nickname || !age) return;
            
            userProfile = {
                nickname: nickname,
                age: age,
                isSetup: true
            };
            
            document.getElementById('welcomeScreen').style.display = 'none';
            showPersonalizedWelcome();
        }

        function showPersonalizedWelcome() {
            const config = window.elementSdk?.config || defaultConfig;
            const botName = config.chatbot_name || defaultConfig.chatbot_name;
            
            let welcomeMsg = `Hi ${userProfile.nickname}! üëã I'm ${botName}, your personal chemistry assistant! `;
            
            if (userProfile.age === '13-15') {
                welcomeMsg += `I'll explain things in a simple and fun way that's perfect for your grade level. Ready to explore the amazing world of stoichiometry together? üß™‚ú®`;
            } else if (userProfile.age === '16-18') {
                welcomeMsg += `I'll help you master stoichiometry concepts for your senior high school chemistry. Let's tackle those challenging problems step by step! üìöüî¨`;
            } else if (userProfile.age === '19-21') {
                welcomeMsg += `Perfect! I'll provide detailed explanations suitable for college-level chemistry. Ready to dive deep into stoichiometric calculations? üéì‚öóÔ∏è`;
            } else {
                welcomeMsg += `Great to meet you! I'll provide comprehensive explanations and advanced problem-solving techniques. Let's explore stoichiometry together! üî¨üìä`;
            }
            
            addMessage(welcomeMsg, 'bot');
        }

        function isRelatedToStoichiometry(message) {
            const lowerMessage = message.toLowerCase();
            
            const enhancedKeywords = [
                ...stoichiometryKeywords,
                'what is', 'explain', 'how to', 'help me', 'teach me', 'show me',
                'calculate', 'solve', 'find', 'determine', 'compute',
                'quiz', 'test', 'exam', 'question', 'practice',
                'balance', 'equation', 'reaction', 'formula',
                'mass', 'weight', 'gram', 'kg', 'pound',
                'percent', 'percentage', 'yield', 'efficiency',
                'limiting', 'excess', 'leftover', 'remaining',
                'avogadro', 'number', 'constant', '6.022',
                'molecular', 'atomic', 'molar', 'molarity',
                'concentration', 'solution', 'mixture',
                'gas', 'liquid', 'solid', 'state', 'phase',
                'temperature', 'pressure', 'volume', 'stp',
                'periodic', 'table', 'element', 'compound',
                'ion', 'ionic', 'covalent', 'bond',
                'coefficient', 'subscript', 'superscript',
                'reactant', 'product', 'catalyst', 'inhibitor'
            ];
            
            const hasChemKeywords = enhancedKeywords.some(keyword => lowerMessage.includes(keyword));
            
            const questionPatterns = [
                /what.*is.*\b(mol|atom|molecule|element|compound|reaction|equation|balance|mass|weight|formula|chemical|chemistry|stoich)/i,
                /how.*to.*\b(calculate|solve|find|balance|determine|compute)/i,
                /explain.*\b(mol|atom|molecule|element|compound|reaction|equation|balance|mass|weight|formula|chemical|chemistry|stoich)/i,
                /help.*me.*\b(with|understand|learn|solve|calculate|balance)/i,
                /\b(quiz|test|practice|exam).*\b(chemistry|chemical|stoich|mol|equation|balance)/i,
                /\b(chemistry|chemical|stoich|mol|equation|balance).*\b(quiz|test|practice|exam)/i
            ];
            
            const hasQuestionPattern = questionPatterns.some(pattern => pattern.test(lowerMessage));
            
            return hasChemKeywords || hasQuestionPattern;
        }

        function addMessage(content, sender, messageType = 'text') {
            const messageData = {
                id: Date.now().toString(),
                message: content,
                sender: sender,
                timestamp: new Date().toISOString(),
                messageType: messageType,
                userNickname: userProfile.nickname || '',
                userAge: userProfile.age || ''
            };

            if (window.dataSdk && chatHistory.length < 999) {
                window.dataSdk.create(messageData);
            } else if (chatHistory.length >= 999) {
                showMessage('Chat history limit reached. Please refresh to continue.', 'system');
            } else {
                chatHistory.push(messageData);
                renderChatHistory();
            }
        }

        function renderChatHistory() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(typingIndicator);

            chatHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                if (msg.messageType === 'quiz') {
                    contentDiv.innerHTML = msg.message;
                } else {
                    contentDiv.textContent = msg.message;
                }
                
                messageDiv.appendChild(contentDiv);
                messagesContainer.appendChild(messageDiv);
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'block';
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isLoading) return;

            if (!userProfile.isSetup) {
                addMessage("Please complete the welcome form first to start our conversation! üòä", 'bot');
                return;
            }

            isLoading = true;
            document.getElementById('sendBtn').disabled = true;
            
            addMessage(message, 'user');
            input.value = '';
            adjustTextareaHeight(input);

            showTyping();
            
            setTimeout(() => {
                const response = generateBotResponse(message);
                hideTyping();
                addMessage(response.content, 'bot', response.type);
                
                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
            }, 1500);
        }

        function sendQuickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        function generateBotResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            const nickname = userProfile.nickname;
            const age = userProfile.age;
            
            if (!isRelatedToStoichiometry(userMessage)) {
                return {
                    type: 'text',
                    content: `I'm sorry ${nickname}, but your question seems to be outside my area of expertise. I'm specifically designed to help with stoichiometry and chemistry-related topics! üß™

I'd love to help you with questions about:
‚Ä¢ Mole concept and calculations
‚Ä¢ Balancing chemical equations  
‚Ä¢ Stoichiometric problem solving
‚Ä¢ Limiting reactants and excess reactants
‚Ä¢ Percent yield calculations
‚Ä¢ Mass-to-mass conversions
‚Ä¢ Molecular and empirical formulas

What would you like to learn about in chemistry today? üòä`
                };
            }
            
            const quizPatterns = [
                /\b(quiz|test|exam|practice|question)\b/i,
                /take.*\b(quiz|test|exam)\b/i,
                /start.*\b(quiz|test|exam)\b/i,
                /give.*me.*\b(quiz|test|question)\b/i,
                /i.*want.*\b(quiz|test|practice)\b/i,
                /can.*i.*\b(take|have|get).*\b(quiz|test)\b/i
            ];
            
            const isQuizRequest = quizPatterns.some(pattern => pattern.test(msg));
            
            if (isQuizRequest) {
                return {
                    type: 'quiz',
                    content: generateQuizSelector()
                };
            }
            
            const calculatorPatterns = [
                /calculator/i,
                /calc/i
            ];
            
            const hasCalculatorKeyword = calculatorPatterns.some(pattern => pattern.test(msg));
            
            const balancePatterns = [
                /\b(balance|balancing)\b.*\b(equation|reaction|formula)\b/i,
                /\b(equation|reaction|formula)\b.*\b(balance|balancing)\b/i,
                /help.*me.*balance/i,
                /how.*to.*balance/i,
                /balance.*chemical/i,
                /chemical.*balance/i,
                /balance.*equations/i,
                /equation.*balancer/i
            ];
            
            const hasBalanceKeywords = balancePatterns.some(pattern => pattern.test(msg)) || 
                                     (msg.includes('balance') && (msg.includes('equation') || msg.includes('equations'))) ||
                                     msg.includes('help me balance') ||
                                     msg.toLowerCase().includes('balance equations') ||
                                     msg.toLowerCase() === 'balance equations' ||
                                     msg.toLowerCase().includes('equation balancer') ||
                                     msg.toLowerCase().includes('chemical balancer');
            
            const wasBalanceButtonClicked = window.balanceEquationRequested || false;
            
            if (wasBalanceButtonClicked && hasCalculatorKeyword) {
                window.balanceEquationRequested = false;
                return {
                    type: 'quiz',
                    content: generateBalanceCalculator()
                };
            }
            
            if (hasBalanceKeywords) {
                window.balanceEquationRequested = true;
                return {
                    type: 'text',
                    content: `I can help you balance equations, ${nickname}! üß™\n\nTo use my interactive equation balancer calculator, please type "calculator" and I'll open it for you.\n\nOr I can explain the balancing process step by step. What would you prefer?`
                };
            }
            
            if (hasCalculatorKeyword && !wasBalanceButtonClicked) {
                return {
                    type: 'text',
                    content: `I have a calculator feature! üßÆ\n\nCurrently, I can help you with:\n‚Ä¢ Chemical equation balancing calculator\n\nTo use the equation balancer, first click "‚öñÔ∏è Balance Equations" or ask me about balancing equations, then type "calculator".\n\nWhat would you like to calculate today?`
                };
            }
            
            const stoichConceptPatterns = [
                /what.*is.*stoich/i,
                /explain.*stoich/i,
                /stoich.*basic/i,
                /basic.*stoich/i,
                /define.*stoich/i,
                /meaning.*stoich/i,
                /stoich.*mean/i
            ];
            
            const isStoichConcept = stoichConceptPatterns.some(pattern => pattern.test(msg)) ||
                                  msg.includes('what is stoichiometry') || 
                                  msg.includes('stoichiometry basics');
            
            if (isStoichConcept) {
                let explanation = `Great question, ${nickname}! üß™ Stoichiometry is like the "recipe math" of chemistry!\n\n`;
                
                if (age === '13-15') {
                    explanation += `Think of it like baking cookies üç™:\n‚Ä¢ If 1 cup of flour makes 12 cookies\n‚Ä¢ Then 2 cups of flour makes 24 cookies\n\nStoichiometry works the same way with chemical reactions! It helps us figure out how much of each chemical we need, or how much product we'll get.\n\nKey ideas:\nüîπ Chemical equations are like recipes\nüîπ We use ratios to calculate amounts\nüîπ Everything must be balanced (like a balanced meal!)`;
                } else if (age === '16-18') {
                    explanation += `Stoichiometry is the quantitative study of chemical reactions. It's based on the law of conservation of mass - matter cannot be created or destroyed.\n\nCore concepts:\nüîπ Balanced chemical equations show exact ratios\nüîπ Mole ratios from coefficients guide calculations\nüîπ Convert between grams, moles, and molecules\nüîπ Predict amounts of reactants needed or products formed\n\nExample: 2H‚ÇÇ + O‚ÇÇ ‚Üí 2H‚ÇÇO\nThis tells us 2 moles H‚ÇÇ react with 1 mole O‚ÇÇ to make 2 moles H‚ÇÇO`;
                } else {
                    explanation += `Stoichiometry is the quantitative relationship between reactants and products in chemical reactions, governed by conservation laws.\n\nFundamental principles:\nüîπ Conservation of mass and atoms\nüîπ Definite proportions in chemical compounds\nüîπ Mole concept as the bridge between atomic and macroscopic scales\nüîπ Stoichiometric coefficients define molar ratios\n\nApplications include:\n‚Ä¢ Industrial process optimization\n‚Ä¢ Environmental impact calculations\n‚Ä¢ Pharmaceutical dosage determinations\n‚Ä¢ Materials science applications`;
                }
                
                return { type: 'text', content: explanation };
            }
            
            return {
                type: 'text',
                content: `I understand you're asking about stoichiometry, ${nickname}! üß™ I can help you with:\n\n‚Ä¢ **Mole concept** and Avogadro's number\n‚Ä¢ **Balancing chemical equations** step by step\n‚Ä¢ **Problem-solving** with detailed explanations\n‚Ä¢ **Mass-to-mass conversions** and calculations\n‚Ä¢ **Limiting reactants** and excess reactants\n‚Ä¢ **Percent yield** calculations\n‚Ä¢ **Practice quizzes** to test your knowledge\n\nCould you be more specific about what you'd like to learn? I'm here to help make chemistry easier for you! üòä`
            };
        }

        function generateQuizSelector() {
            const selectorId = Date.now();
            
            return `
                <div class="quiz-selector-container">
                    <div class="quiz-selector-header">
                        <h3>üéØ Choose Your Quiz Settings</h3>
                        <p>Select difficulty level and number of questions:</p>
                    </div>
                    
                    <div class="quiz-settings">
                        <div class="setting-group">
                            <label>Difficulty Level:</label>
                            <div class="difficulty-options">
                                <button class="difficulty-btn" onclick="selectDifficulty('easy', this, ${selectorId})">üìö Easy</button>
                                <button class="difficulty-btn" onclick="selectDifficulty('normal', this, ${selectorId})">üß™ Normal</button>
                                <button class="difficulty-btn" onclick="selectDifficulty('hard', this, ${selectorId})">üî¨ Hard</button>
                                <button class="difficulty-btn" onclick="selectDifficulty('extreme', this, ${selectorId})">‚öóÔ∏è Extreme</button>
                            </div>
                        </div>
                        
                        <div class="setting-group">
                            <label>Number of Questions:</label>
                            <div class="question-count-options">
                                <button class="count-btn" onclick="selectQuestionCount(5, this, ${selectorId})">5 Questions</button>
                                <button class="count-btn" onclick="selectQuestionCount(10, this, ${selectorId})">10 Questions</button>
                                <button class="count-btn" onclick="selectQuestionCount(15, this, ${selectorId})">15 Questions</button>
                                <button class="count-btn" onclick="selectQuestionCount(20, this, ${selectorId})">20 Questions</button>
                            </div>
                        </div>
                        
                        <button class="start-quiz-btn" id="startQuizBtn${selectorId}" onclick="startCustomQuiz(${selectorId})" disabled>
                            üöÄ Start Quiz
                        </button>
                    </div>
                    
                    <input type="hidden" id="selectedDifficulty${selectorId}">
                    <input type="hidden" id="selectedCount${selectorId}">
                </div>
            `;
        }

        function generateBalanceCalculator() {
            const calcId = Date.now();
            
            return `
                <div class="balance-calculator-container">
                    <div class="calculator-header">
                        <h3>‚öñÔ∏è Chemical Equation Balancer</h3>
                        <p>Enter your chemical equation and I'll balance it for you!</p>
                    </div>
                    
                    <div class="equation-input-section">
                        <div class="input-group">
                            <label>Reactants (left side):</label>
                            <input type="text" id="reactants${calcId}" class="equation-input" placeholder="e.g., H2 + O2" />
                        </div>
                        
                        <div class="arrow-symbol">‚Üí</div>
                        
                        <div class="input-group">
                            <label>Products (right side):</label>
                            <input type="text" id="products${calcId}" class="equation-input" placeholder="e.g., H2O" />
                        </div>
                    </div>
                    
                    <div class="calculator-buttons">
                        <button class="balance-btn" onclick="balanceEquation(${calcId})">‚öñÔ∏è Balance Equation</button>
                        <button class="clear-btn" onclick="clearCalculator(${calcId})">üóëÔ∏è Clear</button>
                    </div>
                    
                    <div class="result-section" id="balanceResult${calcId}" style="display: none;">
                        <div class="balanced-equation" id="balancedEq${calcId}"></div>
                        <div class="explanation" id="explanation${calcId}"></div>
                    </div>
                    
                    <div class="calculator-help">
                        <h4>üí° How to use:</h4>
                        <ul>
                            <li>Use element symbols (H, O, C, N, etc.)</li>
                            <li>Use numbers for subscripts (H2O, CO2)</li>
                            <li>Separate compounds with + (plus sign)</li>
                            <li>Example: "C + O2" ‚Üí "CO2"</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // Balance calculator functions
        function balanceEquation(calcId) {
            const reactants = document.getElementById(`reactants${calcId}`).value.trim();
            const products = document.getElementById(`products${calcId}`).value.trim();
            
            if (!reactants || !products) {
                document.getElementById(`balanceResult${calcId}`).innerHTML = `
                    <div class="error-message">‚ö†Ô∏è Please enter both reactants and products!</div>
                `;
                document.getElementById(`balanceResult${calcId}`).style.display = 'block';
                return;
            }
            
            const balancedResult = performBalancing(reactants, products);
            
            document.getElementById(`balancedEq${calcId}`).innerHTML = `
                <div class="balanced-result">
                    <h4>‚úÖ Balanced Equation:</h4>
                    <div class="equation-display">${balancedResult.equation}</div>
                </div>
            `;
            
            document.getElementById(`explanation${calcId}`).innerHTML = `
                <div class="balance-explanation">
                    <h4>üìù Explanation:</h4>
                    <p>${balancedResult.explanation}</p>
                    <div class="steps">
                        <h5>Steps taken:</h5>
                        <ol>
                            ${balancedResult.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            `;
            
            document.getElementById(`balanceResult${calcId}`).style.display = 'block';
        }

        function clearCalculator(calcId) {
            document.getElementById(`reactants${calcId}`).value = '';
            document.getElementById(`products${calcId}`).value = '';
            document.getElementById(`balanceResult${calcId}`).style.display = 'none';
        }

        function performBalancing(reactants, products) {
            const input = `${reactants} ‚Üí ${products}`.toLowerCase();
            
            const commonEquations = {
                'h2 + o2 ‚Üí h2o': {
                    equation: '2H‚ÇÇ + O‚ÇÇ ‚Üí 2H‚ÇÇO',
                    explanation: 'This is the formation of water. We need 2 molecules of hydrogen to react with 1 molecule of oxygen to form 2 molecules of water.',
                    steps: [
                        'Count atoms: Left side has 2H and 2O, right side has 2H and 1O',
                        'Balance oxygen by adding coefficient 2 to H‚ÇÇO',
                        'Balance hydrogen by adding coefficient 2 to H‚ÇÇ',
                        'Final check: 4H and 2O on both sides ‚úì'
                    ]
                },
                'c + o2 ‚Üí co2': {
                    equation: 'C + O‚ÇÇ ‚Üí CO‚ÇÇ',
                    explanation: 'This equation is already balanced! Each side has 1 carbon atom and 2 oxygen atoms.',
                    steps: [
                        'Count atoms: Left side has 1C and 2O',
                        'Right side has 1C and 2O',
                        'The equation is already balanced!'
                    ]
                },
                'ch4 + o2 ‚Üí co2 + h2o': {
                    equation: 'CH‚ÇÑ + 2O‚ÇÇ ‚Üí CO‚ÇÇ + 2H‚ÇÇO',
                    explanation: 'Methane combustion. We balance carbon first, then hydrogen, and finally oxygen.',
                    steps: [
                        'Balance carbon: 1C on each side ‚úì',
                        'Balance hydrogen: 4H on left, need 2H‚ÇÇO on right',
                        'Balance oxygen: Need 2O‚ÇÇ on left to provide 4O total',
                        'Final check: 1C, 4H, 4O on both sides ‚úì'
                    ]
                }
            };
            
            const normalizedInput = input.replace(/\s+/g, ' ').trim();
            
            for (const [key, value] of Object.entries(commonEquations)) {
                if (normalizedInput.includes(key) || key.includes(normalizedInput.replace(' ‚Üí ', ' + ').split(' + ').join(' ').replace(' ', ''))) {
                    return value;
                }
            }
            
            return {
                equation: `${reactants} ‚Üí ${products}`,
                explanation: `I've identified your equation, but this specific combination isn't in my database yet. Here's the general approach to balance it:`,
                steps: [
                    'Count the atoms of each element on both sides',
                    'Start with the most complex molecule',
                    'Balance metals first, then non-metals',
                    'Balance hydrogen and oxygen last',
                    'Use coefficients (never change subscripts)',
                    'Check that all atoms are balanced'
                ]
            };
        }

        // Quiz selector functions
        function selectDifficulty(difficulty, element, selectorId) {
            document.querySelectorAll(`[onclick*="selectDifficulty"][onclick*="${selectorId}"]`).forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById(`selectedDifficulty${selectorId}`).value = difficulty;
            checkQuizSettings(selectorId);
        }

        function selectQuestionCount(count, element, selectorId) {
            document.querySelectorAll(`[onclick*="selectQuestionCount"][onclick*="${selectorId}"]`).forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById(`selectedCount${selectorId}`).value = count;
            checkQuizSettings(selectorId);
        }

        function checkQuizSettings(selectorId) {
            const difficulty = document.getElementById(`selectedDifficulty${selectorId}`).value;
            const count = document.getElementById(`selectedCount${selectorId}`).value;
            const startBtn = document.getElementById(`startQuizBtn${selectorId}`);
            startBtn.disabled = !difficulty || !count;
        }

        function startCustomQuiz(selectorId) {
            const difficulty = document.getElementById(`selectedDifficulty${selectorId}`).value;
            const count = parseInt(document.getElementById(`selectedCount${selectorId}`).value);
            
            const quizHTML = generateQuiz(difficulty, count);
            addMessage(quizHTML, 'bot', 'quiz');
        }

        function generateQuiz(difficulty = 'normal', questionCount = 5) {
            const quizData = {
                easy: [
                    {
                        question: "What is Avogadro's number?",
                        options: ["6.022 √ó 10¬≤¬≥", "6.022 √ó 10¬≤¬≤", "3.011 √ó 10¬≤¬≥", "1.204 √ó 10¬≤‚Å¥"],
                        correct: 0
                    },
                    {
                        question: "How many atoms are in 1 mole of carbon?",
                        options: ["6.022 √ó 10¬≤¬≥", "12", "6", "24"],
                        correct: 0
                    },
                    {
                        question: "What is the molar mass of water (H‚ÇÇO)? (H=1, O=16)",
                        options: ["16 g/mol", "17 g/mol", "18 g/mol", "19 g/mol"],
                        correct: 2
                    }
                ],
                normal: [
                    {
                        question: "How many moles are in 36g of H‚ÇÇO? (H=1, O=16)",
                        options: ["1 mole", "2 moles", "3 moles", "4 moles"],
                        correct: 1
                    },
                    {
                        question: "In 2H‚ÇÇ + O‚ÇÇ ‚Üí 2H‚ÇÇO, what is the mole ratio of H‚ÇÇ to H‚ÇÇO?",
                        options: ["1:1", "2:1", "1:2", "2:2"],
                        correct: 0
                    }
                ],
                hard: [
                    {
                        question: "Calculate moles of CO‚ÇÇ from 25g C in C + O‚ÇÇ ‚Üí CO‚ÇÇ (C=12)",
                        options: ["2.08 mol", "1.04 mol", "3.12 mol", "0.52 mol"],
                        correct: 0
                    }
                ]
            };
            
            const questions = quizData[difficulty] || quizData.normal;
            const selectedQuestions = questions.slice(0, Math.min(questionCount, questions.length));
            const quizId = Date.now();
            
            let quizHTML = `
                <div class="quiz-container">
                    <div class="quiz-header">
                        <h3>üéØ ${difficulty.toUpperCase()} Quiz (${selectedQuestions.length} Questions)</h3>
                    </div>
                    <div class="quiz-content">
            `;
            
            selectedQuestions.forEach((quiz, qIndex) => {
                quizHTML += `
                    <div class="quiz-question">${qIndex + 1}. ${quiz.question}</div>
                    <div class="quiz-options">
                `;
                
                quiz.options.forEach((option, index) => {
                    quizHTML += `
                        <button class="quiz-option" onclick="selectQuizOption(${quizId}, ${index}, ${quiz.correct})">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </button>
                    `;
                });
                
                quizHTML += `</div><br>`;
            });
            
            quizHTML += `</div></div>`;
            
            return quizHTML;
        }

        function selectQuizOption(quizId, selected, correct) {
            const quizContainer = document.querySelector(`[onclick*="${quizId}"]`).closest('.quiz-container');
            const options = quizContainer.querySelectorAll('.quiz-option');
            
            options.forEach((option, index) => {
                option.onclick = null;
                if (index === correct) {
                    option.classList.add('correct');
                } else if (index === selected && index !== correct) {
                    option.classList.add('incorrect');
                }
            });
            
            setTimeout(() => {
                const feedback = selected === correct ? 
                    `Correct, ${userProfile.nickname}! üéâ Great job!` : 
                    `Not quite right, ${userProfile.nickname}. The correct answer is ${String.fromCharCode(65 + correct)}. Keep practicing! üìö`;
                addMessage(feedback, 'bot');
            }, 1000);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // Enable start button when both fields are filled
        document.getElementById('nickname').addEventListener('input', function() {
            const nickname = this.value.trim();
            const age = document.getElementById('selectedAge').value;
            document.getElementById('startBtn').disabled = !nickname || !age;
        });

        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99622d148657bc55',t:'MTc2MTczNTY5OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
